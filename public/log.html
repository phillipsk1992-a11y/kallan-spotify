<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="theme-color" content="#f5f2eb">
<link rel="manifest" href="/manifest.json">
<title>woodshed</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&display=swap" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --bg: #f5f2eb;
  --fg: #1a1a1a;
  --dim: #888;
  --rule: #ccc;
  --green: #1db954;
  --gig: #e07a2f;
  --int-0: #e8e5de;
  --int-1: #c8dfc0;
  --int-2: #7db868;
  --int-3: #3d8b2a;
  --int-4: #1a5c0e;
}

html, body {
  font-family: 'IBM Plex Mono', monospace;
  background: var(--bg);
  color: var(--fg);
  min-height: 100vh;
  min-height: 100dvh;
  -webkit-font-smoothing: antialiased;
}

body {
  max-width: 480px;
  margin: 0 auto;
  padding: 20px 24px 100px;
  padding-top: env(safe-area-inset-top, 20px);
}

/* ─── Header ─── */
.app-header {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  margin-bottom: 24px;
  padding-top: 8px;
}

.app-name {
  font-size: 20px;
  font-weight: 600;
  letter-spacing: -0.5px;
}

.header-link {
  font-size: 12px;
  color: var(--dim);
  text-decoration: underline;
  text-underline-offset: 2px;
  cursor: pointer;
}

/* ─── Tabs ─── */
.tabs {
  display: flex;
  gap: 0;
  margin-bottom: 22px;
  border-bottom: 1px solid var(--rule);
}

.tabs button {
  font-family: inherit;
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: var(--dim);
  background: none;
  border: none;
  padding: 9px 16px 9px 0;
  border-bottom: 1.5px solid transparent;
  margin-bottom: -1px;
  cursor: pointer;
}

.tabs button.active {
  color: var(--fg);
  border-bottom-color: var(--fg);
}

/* ─── Divider ─── */
.divider {
  color: var(--rule);
  font-size: 11px;
  margin: 22px 0;
  overflow: hidden;
  white-space: nowrap;
  user-select: none;
}

.section-label {
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 2px;
  color: var(--dim);
  margin-bottom: 12px;
}

/* ─── Tab Content ─── */
.tab-content { display: none; }
.tab-content.active { display: block; }

/* ═══════════════════════════════════════ */
/* HOME TAB                               */
/* ═══════════════════════════════════════ */

.home-greeting {
  font-size: 18px;
  font-weight: 400;
  margin-bottom: 4px;
}

.home-date {
  font-size: 12px;
  color: var(--dim);
  margin-bottom: 26px;
}

/* Week visualisation */
.week-viz {
  display: flex;
  gap: 8px;
  justify-content: center;
  margin-bottom: 6px;
}

.week-viz .day-wrap {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 5px;
}

.week-viz .day-cell {
  width: 42px;
  height: 42px;
  border-radius: 3px;
}

.week-viz .day-cell.future {
  background: var(--int-0);
  border: 1.5px dashed var(--rule);
}

.week-viz .day-cell.gig-day {
  border-radius: 50%;
}

.week-viz .day-name {
  font-size: 10px;
  color: var(--dim);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* Status lines */
.status-line {
  display: flex;
  align-items: center;
  padding: 11px 0;
  border-bottom: 1px solid #eae7e0;
  font-size: 13px;
}

.status-line .dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  margin-right: 12px;
  flex-shrink: 0;
}

.status-line .dot.green {
  background: var(--green);
  box-shadow: 0 0 6px rgba(29,185,84,0.4);
}

.status-line .dot.orange { background: var(--gig); }
.status-line .dot.grey { background: #bbb; }

.status-line .status-label {
  width: 90px;
  color: var(--dim);
  font-size: 12px;
}

.status-line .status-value { flex: 1; }

/* Home CTA */
.home-cta {
  display: block;
  width: 100%;
  background: var(--fg);
  color: var(--bg);
  border: none;
  font-family: inherit;
  font-size: 13px;
  text-transform: uppercase;
  letter-spacing: 2px;
  padding: 16px;
  cursor: pointer;
  text-align: center;
  margin-top: 8px;
}

.home-footer {
  text-align: center;
  font-size: 11px;
  color: #bbb;
  margin-top: 24px;
  line-height: 1.7;
  font-style: italic;
}

/* ═══════════════════════════════════════ */
/* LOG TAB                                */
/* ═══════════════════════════════════════ */

.category-grid {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 7px;
  margin-bottom: 10px;
}

.cat-btn {
  background: transparent;
  border: 1px solid var(--rule);
  font-family: inherit;
  font-size: 13px;
  padding: 15px 6px;
  text-align: center;
  color: var(--fg);
  cursor: pointer;
  transition: background 0.15s, color 0.15s;
}

.cat-btn.selected {
  background: var(--fg);
  color: var(--bg);
  border-color: var(--fg);
}

.gig-btn {
  width: 100%;
  background: transparent;
  border: 1px solid var(--gig);
  font-family: inherit;
  font-size: 13px;
  padding: 15px 6px;
  text-align: center;
  color: var(--gig);
  margin-bottom: 22px;
  cursor: pointer;
  transition: background 0.15s, color 0.15s;
}

.gig-btn.selected {
  background: var(--gig);
  color: var(--bg);
}

/* Venue field */
.venue-field {
  width: 100%;
  background: transparent;
  border: 1px solid var(--gig);
  font-family: inherit;
  font-size: 13px;
  padding: 11px 12px;
  color: var(--fg);
  margin-bottom: 14px;
  display: none;
}

.venue-field::placeholder { color: #d4a57a; }
.venue-field:focus { outline: none; border-color: var(--gig); }
.venue-field.visible { display: block; }

/* Duration controls */
.duration-row {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 20px;
  margin-bottom: 10px;
}

.dur-btn {
  width: 42px;
  height: 42px;
  border: 1px solid var(--rule);
  background: transparent;
  font-family: inherit;
  font-size: 20px;
  color: var(--fg);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
}

.dur-display {
  font-size: 38px;
  font-weight: 300;
  min-width: 110px;
  text-align: center;
}

.dur-display span {
  font-size: 14px;
  color: var(--dim);
  font-weight: 400;
}

.quick-mins {
  display: flex;
  justify-content: center;
  gap: 8px;
  margin-bottom: 18px;
}

.quick-mins button {
  font-family: inherit;
  font-size: 11px;
  color: var(--dim);
  border: 1px solid #ddd;
  padding: 5px 11px;
  background: transparent;
  cursor: pointer;
  transition: border-color 0.15s;
}

.quick-mins button:active {
  border-color: var(--fg);
  color: var(--fg);
}

/* Notes field */
.notes-field {
  width: 100%;
  background: transparent;
  border: 1px solid var(--rule);
  font-family: inherit;
  font-size: 13px;
  padding: 11px 12px;
  color: var(--fg);
  margin-bottom: 14px;
  resize: none;
}

.notes-field::placeholder { color: #b0ada6; }
.notes-field:focus { outline: none; border-color: var(--fg); }

/* Log button */
.log-btn {
  width: 100%;
  background: var(--fg);
  color: var(--bg);
  border: none;
  font-family: inherit;
  font-size: 13px;
  text-transform: uppercase;
  letter-spacing: 2px;
  padding: 15px;
  cursor: pointer;
  transition: opacity 0.15s;
}

.log-btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

.log-btn.success {
  background: var(--int-3);
}

/* Today entries */
.today-entry {
  display: flex;
  justify-content: space-between;
  font-size: 13px;
  padding: 7px 0;
  border-bottom: 1px solid #eae7e0;
}

.today-entry .entry-cat { color: var(--dim); }
.today-entry .entry-dur { font-weight: 500; }
.today-entry .entry-gig { color: var(--gig); }

.today-total {
  display: flex;
  justify-content: space-between;
  font-size: 13px;
  padding: 9px 0 0;
  font-weight: 600;
}

/* ═══════════════════════════════════════ */
/* STATS TAB                              */
/* ═══════════════════════════════════════ */

.stats-row {
  display: flex;
  justify-content: space-around;
  text-align: center;
  margin-bottom: 24px;
}

.stats-top-row {
  padding-top: 12px;
  margin-bottom: 28px;
}

.stats-top-row .stat-item-num {
  font-size: 36px;
  font-weight: 300;
}

.stats-top-row .stat-item-label {
  font-size: 10px;
}

.stat-item .stat-item-num {
  font-size: 24px;
  font-weight: 400;
}

.stat-item .stat-item-label {
  font-size: 10px;
  color: var(--dim);
  text-transform: uppercase;
  letter-spacing: 1.5px;
  margin-top: 3px;
}

/* Grid header */
.grid-header {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  margin-bottom: 8px;
}

.grid-header .section-label { margin-bottom: 0; }

.share-link {
  font-size: 11px;
  color: var(--dim);
  text-decoration: underline;
  text-underline-offset: 2px;
  cursor: pointer;
  background: none;
  border: none;
  font-family: inherit;
}

/* Month labels */
.grid-months {
  display: flex;
  justify-content: space-between;
  font-size: 9px;
  color: var(--dim);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 4px;
  padding: 0 1px;
}

/* Contribution grid */
.streak-grid {
  display: grid;
  grid-template-columns: repeat(52, 1fr);
  grid-template-rows: repeat(7, 1fr);
  grid-auto-flow: column;
  gap: 2px;
}

.streak-cell {
  aspect-ratio: 1;
  border-radius: 1px;
  min-width: 0;
}

.streak-cell.em { background: var(--int-0); }
.streak-cell.lt { background: var(--int-1); }
.streak-cell.md { background: var(--int-2); }
.streak-cell.hv { background: var(--int-3); }
.streak-cell.it { background: var(--int-4); }
.streak-cell.gi { background: var(--gig); border-radius: 50%; }
.streak-cell.future { opacity: 0.3; }

.grid-legend {
  display: flex;
  align-items: center;
  justify-content: flex-end;
  gap: 3px;
  margin-top: 6px;
  font-size: 9px;
  color: var(--dim);
}

.grid-legend .swatch {
  width: 8px;
  height: 8px;
  border-radius: 1px;
}

.grid-legend .swatch.gig-swatch { border-radius: 50%; }

/* Category bars */
.cat-bar-row {
  display: flex;
  align-items: center;
  margin-bottom: 9px;
}

.cat-bar-label {
  width: 82px;
  color: var(--dim);
  font-size: 12px;
}

.cat-bar-track {
  flex: 1;
  height: 6px;
  background: var(--int-0);
  margin: 0 10px;
}

.cat-bar-fill {
  height: 100%;
  background: var(--fg);
  transition: width 0.4s ease;
}

.cat-bar-fill.top { background: var(--green); }

.cat-bar-hours {
  font-size: 11px;
  color: var(--dim);
  width: 34px;
  text-align: right;
}

/* Gig entries */
.gig-entry {
  padding: 12px 0;
  border-bottom: 1px solid #eae7e0;
}

.gig-entry .gig-top {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  margin-bottom: 3px;
}

.gig-entry .gig-venue {
  font-size: 13px;
  font-weight: 500;
}

.gig-entry .gig-date {
  font-size: 12px;
  color: var(--dim);
}

.gig-entry .gig-detail {
  font-size: 12px;
  color: var(--dim);
}

.gig-dot {
  display: inline-block;
  width: 6px;
  height: 6px;
  background: var(--gig);
  border-radius: 50%;
  margin-right: 7px;
  vertical-align: middle;
}

.stats-footer {
  text-align: center;
  font-size: 11px;
  color: #bbb;
  margin-top: 14px;
  line-height: 1.6;
}

/* ═══════════════════════════════════════ */
/* SHARE FLOW                             */
/* ═══════════════════════════════════════ */

#share-view { display: none; }
#share-view.active { display: block; }

.share-back {
  font-size: 10px;
  color: var(--dim);
  text-decoration: underline;
  text-underline-offset: 2px;
  cursor: pointer;
  background: none;
  border: none;
  font-family: inherit;
}

.reflect-prompt {
  font-size: 14px;
  color: var(--fg);
  margin-bottom: 16px;
  line-height: 1.5;
}

.reflect-input {
  width: 100%;
  background: transparent;
  border: 1px solid var(--rule);
  font-family: inherit;
  font-size: 13px;
  padding: 14px;
  color: var(--fg);
  resize: none;
  line-height: 1.5;
}

.reflect-input::placeholder { color: #b0ada6; }
.reflect-input:focus { outline: none; border-color: var(--fg); }

.skip-link {
  font-size: 11px;
  color: var(--dim);
  text-decoration: underline;
  text-underline-offset: 2px;
  cursor: pointer;
  text-align: right;
  display: block;
  margin-top: 10px;
  background: none;
  border: none;
  font-family: inherit;
  margin-left: auto;
}

/* Preview */
.preview-label {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 2px;
  color: var(--dim);
  margin-bottom: 8px;
}

/* Card type selector */
.card-type-selector {
  display: flex;
  gap: 8px;
  margin-bottom: 14px;
}

.card-type-btn {
  flex: 1;
  background: transparent;
  border: 1px solid var(--rule);
  font-family: inherit;
  padding: 14px 8px;
  cursor: pointer;
  text-align: center;
  transition: all 0.15s;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
  color: var(--fg);
}

.card-type-btn.selected {
  background: var(--fg);
  color: var(--bg);
  border-color: var(--fg);
}

.card-type-icon {
  font-size: 18px;
  line-height: 1;
}

.card-type-name {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 1.5px;
}

.card-type-desc {
  font-size: 12px;
  color: var(--dim);
  text-align: center;
  margin-bottom: 8px;
  font-style: italic;
}

/* Card preview */
.card-preview-container {
  margin-bottom: 16px;
}

.card-preview-container canvas {
  width: 100%;
  border: 1px solid var(--rule);
}

.generate-btn {
  width: 100%;
  background: var(--fg);
  color: var(--bg);
  border: none;
  font-family: inherit;
  font-size: 13px;
  text-transform: uppercase;
  letter-spacing: 2px;
  padding: 15px;
  cursor: pointer;
}

/* Card view */
#card-view { display: none; }
#card-view.active { display: block; }

/* Share actions */
.share-actions {
  display: flex;
  gap: 8px;
  margin-top: 16px;
}

.share-action-btn {
  flex: 1;
  background: transparent;
  border: 1px solid var(--rule);
  font-family: inherit;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  padding: 12px;
  color: var(--fg);
  text-align: center;
  cursor: pointer;
}

.share-action-btn.primary {
  background: var(--fg);
  color: var(--bg);
  border-color: var(--fg);
}

.share-size {
  text-align: center;
  font-size: 11px;
  color: var(--dim);
  margin-top: 14px;
}

/* ─── Toast ─── */
.toast {
  position: fixed;
  bottom: 80px;
  left: 50%;
  transform: translateX(-50%) translateY(20px);
  background: var(--fg);
  color: var(--bg);
  font-family: inherit;
  font-size: 12px;
  letter-spacing: 1px;
  padding: 12px 24px;
  opacity: 0;
  transition: opacity 0.3s, transform 0.3s;
  pointer-events: none;
  z-index: 100;
}

.toast.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}

/* ─── Loading ─── */
.loading {
  text-align: center;
  font-size: 10px;
  color: var(--dim);
  padding: 40px 0;
  letter-spacing: 1px;
}

/* ─── Canvas (offscreen) ─── */
#share-canvas { display: none; }

/* Focus states */
input:focus, textarea:focus, button:focus { outline: none; }
</style>
</head>
<body>

<!-- App Header -->
<div class="app-header">
  <div class="app-name">woodshed</div>
  <div class="header-link" id="header-link" style="display:none;"></div>
</div>

<!-- Tab Navigation -->
<div class="tabs" id="main-tabs">
  <button class="active" data-tab="home">home</button>
  <button data-tab="log">log</button>
  <button data-tab="stats">stats</button>
</div>

<!-- ═══════════════════════════════════ HOME ═══════════════════════════════════ -->
<div class="tab-content active" id="tab-home">
  <div class="home-greeting" id="greeting"></div>
  <div class="home-date" id="home-date"></div>

  <div class="week-viz" id="week-viz"></div>

  <div class="divider">&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;</div>

  <div id="status-lines"></div>

  <div class="divider">&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;</div>

  <button class="home-cta" id="home-cta">log session</button>

  <div class="home-footer">"the woodshed is where<br>the work gets done."</div>
</div>

<!-- ═══════════════════════════════════ LOG ═══════════════════════════════════ -->
<div class="tab-content" id="tab-log">
  <div class="section-label">Category</div>
  <div class="category-grid" id="cat-grid">
    <button class="cat-btn" data-cat="technique">technique</button>
    <button class="cat-btn" data-cat="reading">reading</button>
    <button class="cat-btn" data-cat="chords">chords</button>
    <button class="cat-btn" data-cat="scales">scales</button>
    <button class="cat-btn" data-cat="tunes">tunes</button>
    <button class="cat-btn" data-cat="theory">theory</button>
  </div>
  <button class="gig-btn" id="gig-btn">&#9670; log a gig</button>
  <input type="text" class="venue-field" id="venue-field" placeholder="venue name">

  <div class="section-label">Duration</div>
  <div class="duration-row">
    <button class="dur-btn" id="dur-minus">&minus;</button>
    <div class="dur-display"><span id="dur-value">20</span> <span>min</span></div>
    <button class="dur-btn" id="dur-plus">+</button>
  </div>
  <div class="quick-mins" id="quick-mins">
    <button data-min="5">5</button>
    <button data-min="10">10</button>
    <button data-min="15">15</button>
    <button data-min="20">20</button>
    <button data-min="30">30</button>
    <button data-min="45">45</button>
    <button data-min="60">60</button>
  </div>

  <textarea class="notes-field" id="notes-field" rows="1" placeholder="notes (optional)"></textarea>
  <button class="log-btn" id="log-btn">log</button>

  <div class="divider">&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;</div>
  <div class="section-label">Today</div>
  <div id="today-entries"></div>
</div>

<!-- ═══════════════════════════════════ STATS ═══════════════════════════════════ -->
<div class="tab-content" id="tab-stats">
  <div class="stats-row stats-top-row">
    <div class="stat-item">
      <div class="stat-item-num" id="week-hours">--</div>
      <div class="stat-item-label">hours this week</div>
    </div>
    <div class="stat-item">
      <div class="stat-item-num" id="month-hours">--</div>
      <div class="stat-item-label" id="month-label">hours in --</div>
    </div>
    <div class="stat-item">
      <div class="stat-item-num" id="year-hours">--</div>
      <div class="stat-item-label">hours this year</div>
    </div>
  </div>

  <div class="divider">&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;</div>

  <div class="grid-header">
    <div class="section-label" id="grid-year">2026</div>
    <button class="share-link" id="share-week-btn">share &#8599;</button>
  </div>
  <div class="grid-months">
    <span>J</span><span>F</span><span>M</span><span>A</span><span>M</span><span>J</span><span>J</span><span>A</span><span>S</span><span>O</span><span>N</span><span>D</span>
  </div>
  <div class="streak-grid" id="streak-grid"></div>
  <div class="grid-legend">
    <span>less</span>
    <div class="swatch" style="background: var(--int-0);"></div>
    <div class="swatch" style="background: var(--int-1);"></div>
    <div class="swatch" style="background: var(--int-2);"></div>
    <div class="swatch" style="background: var(--int-3);"></div>
    <div class="swatch" style="background: var(--int-4);"></div>
    <span>more</span>
    <span style="margin: 0 4px;">&middot;</span>
    <div class="swatch gig-swatch" style="background: var(--gig);"></div>
    <span>gig</span>
  </div>

  <div class="divider">&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;</div>
  <div class="section-label">Breakdown</div>
  <div id="category-bars"></div>

  <div class="divider">&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;</div>
  <div class="section-label">Recent Gigs</div>
  <div id="recent-gigs"></div>

  <div class="stats-footer">practice logged manually.<br>accountability through transparency.</div>
</div>

<!-- ═══════════════════════════════════ SHARE FLOW ═══════════════════════════════════ -->
<div id="share-view">
  <div class="section-label">Share your progress</div>

  <div class="card-type-selector">
    <button class="card-type-btn selected" data-card="week">
      <span class="card-type-icon">&#9632;</span>
      <span class="card-type-name">week</span>
    </button>
    <button class="card-type-btn" data-card="grind">
      <span class="card-type-icon">&#9612;</span>
      <span class="card-type-name">grind</span>
    </button>
    <button class="card-type-btn" data-card="streak">
      <span class="card-type-icon">&#9617;</span>
      <span class="card-type-name">long game</span>
    </button>
  </div>

  <div class="card-type-desc" id="card-type-desc">your week at a glance</div>

  <div class="divider">&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;</div>

  <div class="reflect-prompt">Anything worth<br>remembering?</div>
  <textarea class="reflect-input" id="reflect-input" rows="3" placeholder="optional -- skip if nothing comes to mind"></textarea>
  <button class="skip-link" id="skip-reflect">skip &#8594;</button>

  <div class="divider">&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;</div>

  <button class="generate-btn" id="generate-btn">generate card</button>
</div>

<!-- ═══════════════════════════════════ CARD VIEW ═══════════════════════════════════ -->
<div id="card-view">
  <div class="card-preview-container" id="card-preview-container"></div>

  <div class="share-actions">
    <button class="share-action-btn" id="save-image-btn">save image</button>
    <button class="share-action-btn primary" id="share-btn">share</button>
  </div>
  <div class="share-size">1080 &times; 1920</div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Offscreen canvas for card generation -->
<canvas id="share-canvas" width="1080" height="1920"></canvas>

<script>
// ═══════════════════════════════════════════
// CONFIG
// ═══════════════════════════════════════════
const API_URL = '/api/practice-log';
const API_SECRET = 'kallanpracticelog92'; // Set via env or replace

const INTENSITY_COLORS = ['#e8e5de', '#c8dfc0', '#7db868', '#3d8b2a', '#1a5c0e'];
const GIG_COLOR = '#e07a2f';
const BG_COLOR = '#f5f2eb';
const FG_COLOR = '#1a1a1a';
const DIM_COLOR = '#888888';

// ═══════════════════════════════════════════
// STATE
// ═══════════════════════════════════════════
let appData = null;
let selectedCategory = null;
let isGigMode = false;
let duration = 20;
let currentView = 'main'; // main | share | card

// ═══════════════════════════════════════════
// API
// ═══════════════════════════════════════════
async function fetchStats() {
  try {
    const resp = await fetch(API_URL + '?tz=' + new Date().getTimezoneOffset(), {});
    if (!resp.ok) {
      const body = await resp.text();
      console.error(`API ${resp.status}: ${body}`);
      showToast(`api error: ${resp.status}`);
      return;
    }
    appData = await resp.json();
    renderAll();
  } catch (err) {
    console.error('Failed to fetch stats:', err);
    showToast('could not reach api');
  }
}

async function logEntry(category, minutes, notes, type, venue) {
  try {
    const resp = await fetch(API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${API_SECRET}`,
      },
      body: JSON.stringify({ category, minutes, notes, type, venue }),
    });
    if (!resp.ok) throw new Error('API error');
    return await resp.json();
  } catch (err) {
    console.error('Failed to log entry:', err);
    throw err;
  }
}

// ═══════════════════════════════════════════
// RENDERING
// ═══════════════════════════════════════════
function renderAll() {
  if (!appData) return;
  renderHome();
  renderLog();
  renderStats();
}

// ─── Home Tab ───
function renderHome() {
  // Greeting
  const hour = new Date().getHours();
  let greet = 'Good evening.';
  if (hour < 12) greet = 'Good morning.';
  else if (hour < 17) greet = 'Good afternoon.';
  document.getElementById('greeting').textContent = greet;

  // Date + streak
  const now = new Date();
  const options = { weekday: 'long', month: 'long', day: 'numeric' };
  const dateStr = now.toLocaleDateString('en-US', options);
  const streakStr = appData.streak > 0 ? ` \u00B7 Day ${appData.streak} of your streak` : '';
  document.getElementById('home-date').textContent = dateStr + streakStr;

  // Week visualisation
  const weekViz = document.getElementById('week-viz');
  weekViz.innerHTML = '';
  if (appData.week && appData.week.days) {
    appData.week.days.forEach(day => {
      const wrap = document.createElement('div');
      wrap.className = 'day-wrap';

      const cell = document.createElement('div');
      cell.className = 'day-cell';
      if (day.isFuture) {
        cell.classList.add('future');
      } else if (day.hasGig) {
        cell.classList.add('gig-day');
        cell.style.background = GIG_COLOR;
      } else {
        cell.style.background = INTENSITY_COLORS[day.intensity] || INTENSITY_COLORS[0];
      }

      const name = document.createElement('div');
      name.className = 'day-name';
      name.textContent = day.dayLabel;

      wrap.appendChild(cell);
      wrap.appendChild(name);
      weekViz.appendChild(wrap);
    });
  }

  // Status lines
  const statusEl = document.getElementById('status-lines');
  statusEl.innerHTML = '';

  // Last practiced
  if (appData.lastPractice) {
    const ts = new Date(appData.lastPractice.timestamp);
    const ago = timeAgo(ts);
    addStatusLine(statusEl, 'green', 'practiced', `${ago} \u00B7 ${appData.lastPractice.minutes}m ${appData.lastPractice.category}`);
  }

  // Last gig
  if (appData.lastGig) {
    const ts = new Date(appData.lastGig.timestamp);
    const ago = timeAgo(ts);
    addStatusLine(statusEl, 'orange', 'gigged', `${ago} \u00B7 ${appData.lastGig.venue || 'gig'} \u00B7 ${appData.lastGig.minutes}m`);
  }

  // This week
  if (appData.week) {
    const hrs = formatHours(appData.week.totalMinutes);
    const sessions = appData.week.sessionCount;
    addStatusLine(statusEl, 'grey', 'this week', `${hrs} \u00B7 ${sessions} sessions`);
  }

  // This month
  if (appData.month) {
    const hrs = formatHours(appData.month.totalMinutes);
    const gigs = appData.month.gigCount;
    addStatusLine(statusEl, 'grey', 'this month', `${hrs} \u00B7 ${gigs} gig${gigs !== 1 ? 's' : ''}`);
  }
}

function addStatusLine(parent, dotClass, label, value) {
  const line = document.createElement('div');
  line.className = 'status-line';
  line.innerHTML = `
    <div class="dot ${dotClass}"></div>
    <span class="status-label">${label}</span>
    <span class="status-value">${value}</span>
  `;
  parent.appendChild(line);
}

// ─── Log Tab ───
function renderLog() {
  const entriesEl = document.getElementById('today-entries');
  entriesEl.innerHTML = '';

  if (!appData.today || appData.today.entries.length === 0) {
    entriesEl.innerHTML = '<div style="font-size:12px;color:var(--dim);padding:10px 0;">no entries yet today</div>';
    return;
  }

  appData.today.entries.forEach(e => {
    const row = document.createElement('div');
    row.className = 'today-entry';
    if (e.type === 'gig') {
      row.innerHTML = `
        <span class="entry-gig">\u25C6 ${e.venue || 'gig'}</span>
        <span class="entry-dur">${e.minutes}m</span>
      `;
    } else {
      row.innerHTML = `
        <span class="entry-cat">${e.category}</span>
        <span class="entry-dur">${e.minutes}m</span>
      `;
    }
    entriesEl.appendChild(row);
  });

  // Total
  const total = document.createElement('div');
  total.className = 'today-total';
  total.innerHTML = `<span>total</span><span>${formatMinutes(appData.today.totalMinutes)}</span>`;
  entriesEl.appendChild(total);
}

// ─── Stats Tab ───
function renderStats() {
  // Week hours
  const weekHrs = parseFloat((appData.week.totalMinutes / 60).toFixed(1));
  document.getElementById('week-hours').textContent = weekHrs;

  // Month hours with month name
  const monthHrs = parseFloat((appData.month.totalMinutes / 60).toFixed(1));
  document.getElementById('month-hours').textContent = monthHrs;
  document.getElementById('month-label').textContent = 'hours in ' + (appData.month.name || '--');

  // Year hours
  const yearHrs = Math.round((appData.year ? appData.year.totalMinutes : 0) / 60);
  document.getElementById('year-hours').textContent = yearHrs;

  // Year label
  document.getElementById('grid-year').textContent = new Date().getFullYear();

  // Contribution grid
  const gridEl = document.getElementById('streak-grid');
  gridEl.innerHTML = '';
  if (appData.grid) {
    appData.grid.forEach(cell => {
      const el = document.createElement('div');
      el.className = 'streak-cell';
      if (cell.hasGig) {
        el.classList.add('gi');
      } else if (cell.intensity === -1) {
        el.classList.add('em', 'future');
      } else if (cell.intensity === 0) {
        el.classList.add('em');
      } else if (cell.intensity === 1) {
        el.classList.add('lt');
      } else if (cell.intensity === 2) {
        el.classList.add('md');
      } else if (cell.intensity === 3) {
        el.classList.add('hv');
      } else {
        el.classList.add('it');
      }
      gridEl.appendChild(el);
    });
  }

  // Category breakdown
  const barsEl = document.getElementById('category-bars');
  barsEl.innerHTML = '';
  const categories = appData.categoryBreakdownMonth || {};
  const sorted = Object.entries(categories).sort((a, b) => b[1] - a[1]);
  const maxMins = sorted.length > 0 ? sorted[0][1] : 1;

  sorted.forEach(([ cat, mins ], i) => {
    const pct = Math.round((mins / maxMins) * 100);
    const hrs = Math.round(mins / 60);
    const row = document.createElement('div');
    row.className = 'cat-bar-row';
    row.innerHTML = `
      <span class="cat-bar-label">${cat}</span>
      <div class="cat-bar-track"><div class="cat-bar-fill${i === 0 ? ' top' : ''}" style="width:${pct}%;"></div></div>
      <span class="cat-bar-hours">${hrs}h</span>
    `;
    barsEl.appendChild(row);
  });

  // Recent gigs
  const gigsEl = document.getElementById('recent-gigs');
  gigsEl.innerHTML = '';
  if (appData.recentGigs && appData.recentGigs.length > 0) {
    appData.recentGigs.forEach(g => {
      const d = new Date(g.timestamp);
      const dateStr = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      const durStr = formatMinutes(g.minutes);
      const entry = document.createElement('div');
      entry.className = 'gig-entry';
      entry.innerHTML = `
        <div class="gig-top">
          <span class="gig-venue"><span class="gig-dot"></span>${g.venue || 'Gig'}</span>
          <span class="gig-date">${dateStr}</span>
        </div>
        <div class="gig-detail">${g.notes ? g.notes + ' \u00B7 ' : ''}${durStr}</div>
      `;
      gigsEl.appendChild(entry);
    });
  } else {
    gigsEl.innerHTML = '<div style="font-size:12px;color:var(--dim);padding:10px 0;">no gigs logged yet</div>';
  }
}

// ═══════════════════════════════════════════
// TAB NAVIGATION
// ═══════════════════════════════════════════
document.querySelectorAll('#main-tabs button').forEach(btn => {
  btn.addEventListener('click', () => {
    if (currentView !== 'main') {
      showMainView();
    }
    switchTab(btn.dataset.tab);
  });
});

function switchTab(tabName) {
  document.querySelectorAll('#main-tabs button').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));

  document.querySelector(`#main-tabs button[data-tab="${tabName}"]`).classList.add('active');
  document.getElementById(`tab-${tabName}`).classList.add('active');
}

// Home CTA → Log tab
document.getElementById('home-cta').addEventListener('click', () => {
  switchTab('log');
});

// ═══════════════════════════════════════════
// LOG INTERACTION
// ═══════════════════════════════════════════

// Category selection
document.querySelectorAll('.cat-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    selectedCategory = btn.dataset.cat;
    isGigMode = false;
    document.getElementById('gig-btn').classList.remove('selected');
    document.getElementById('venue-field').classList.remove('visible');
  });
});

// Gig button
document.getElementById('gig-btn').addEventListener('click', () => {
  isGigMode = !isGigMode;
  document.getElementById('gig-btn').classList.toggle('selected', isGigMode);
  document.getElementById('venue-field').classList.toggle('visible', isGigMode);
  if (isGigMode) {
    document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('selected'));
    selectedCategory = null;
    document.getElementById('venue-field').focus();
  }
});

// Duration
document.getElementById('dur-minus').addEventListener('click', () => {
  duration = Math.max(5, duration - 5);
  document.getElementById('dur-value').textContent = duration;
});

document.getElementById('dur-plus').addEventListener('click', () => {
  duration = Math.min(480, duration + 5);
  document.getElementById('dur-value').textContent = duration;
});

document.querySelectorAll('#quick-mins button').forEach(btn => {
  btn.addEventListener('click', () => {
    duration = parseInt(btn.dataset.min);
    document.getElementById('dur-value').textContent = duration;
  });
});

// Log submission
document.getElementById('log-btn').addEventListener('click', async () => {
  const btn = document.getElementById('log-btn');
  const notes = document.getElementById('notes-field').value.trim();
  const venue = document.getElementById('venue-field').value.trim();

  if (isGigMode) {
    if (!venue) {
      showToast('enter a venue name');
      return;
    }
    btn.disabled = true;
    btn.textContent = 'logging...';
    try {
      await logEntry('gig', duration, notes, 'gig', venue);
      btn.textContent = 'logged';
      btn.classList.add('success');
      document.getElementById('venue-field').value = '';
      document.getElementById('notes-field').value = '';
      isGigMode = false;
      document.getElementById('gig-btn').classList.remove('selected');
      document.getElementById('venue-field').classList.remove('visible');
      await fetchStats();
      setTimeout(() => {
        btn.textContent = 'log';
        btn.classList.remove('success');
        btn.disabled = false;
      }, 1200);
    } catch {
      btn.textContent = 'error';
      setTimeout(() => { btn.textContent = 'log'; btn.disabled = false; }, 1500);
    }
  } else {
    if (!selectedCategory) {
      showToast('pick a category');
      return;
    }
    btn.disabled = true;
    btn.textContent = 'logging...';
    try {
      await logEntry(selectedCategory, duration, notes, 'practice', '');
      btn.textContent = 'logged';
      btn.classList.add('success');
      document.getElementById('notes-field').value = '';
      await fetchStats();
      setTimeout(() => {
        btn.textContent = 'log';
        btn.classList.remove('success');
        btn.disabled = false;
      }, 1200);
    } catch {
      btn.textContent = 'error';
      setTimeout(() => { btn.textContent = 'log'; btn.disabled = false; }, 1500);
    }
  }
});

// ═══════════════════════════════════════════
// SHARE FLOW
// ═══════════════════════════════════════════
let selectedCardType = 'week';
const cardDescriptions = {
  week: 'your week at a glance',
  grind: 'what you worked on',
  streak: 'the big picture',
};

// Card type selector
document.querySelectorAll('.card-type-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.card-type-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    selectedCardType = btn.dataset.card;
    document.getElementById('card-type-desc').textContent = cardDescriptions[selectedCardType];
  });
});

document.getElementById('share-week-btn').addEventListener('click', () => {
  showShareView();
});

function showShareView() {
  currentView = 'share';
  document.getElementById('main-tabs').style.display = 'none';
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.getElementById('share-view').classList.add('active');
  document.getElementById('card-view').classList.remove('active');

  const link = document.getElementById('header-link');
  link.style.display = 'inline';
  link.textContent = '\u2190 stats';
  link.onclick = () => showMainView();
}

document.getElementById('skip-reflect').addEventListener('click', () => {
  document.getElementById('reflect-input').value = '';
  generateCard();
});

document.getElementById('generate-btn').addEventListener('click', () => {
  generateCard();
});

function generateCard() {
  currentView = 'card';
  document.getElementById('share-view').classList.remove('active');
  document.getElementById('card-view').classList.add('active');

  const link = document.getElementById('header-link');
  link.textContent = '\u2190 back';
  link.onclick = () => showShareView();

  if (!appData) return;

  const reflection = document.getElementById('reflect-input').value.trim();
  const canvas = document.getElementById('share-canvas');
  const ctx = canvas.getContext('2d');

  if (selectedCardType === 'week') {
    renderWeekCard(ctx, reflection);
  } else if (selectedCardType === 'grind') {
    renderGrindCard(ctx, reflection);
  } else if (selectedCardType === 'streak') {
    renderStreakCard(ctx, reflection);
  }

  // Show canvas preview
  const container = document.getElementById('card-preview-container');
  container.innerHTML = '';
  const preview = document.createElement('canvas');
  preview.width = 1080;
  preview.height = 1920;
  preview.getContext('2d').drawImage(canvas, 0, 0);
  container.appendChild(preview);
}

function showMainView() {
  currentView = 'main';
  document.getElementById('main-tabs').style.display = 'flex';
  document.getElementById('share-view').classList.remove('active');
  document.getElementById('card-view').classList.remove('active');
  document.getElementById('header-link').style.display = 'none';
  switchTab('stats');
}

// ═══════════════════════════════════════════
// CANVAS HELPERS
// ═══════════════════════════════════════════
const CW = 1080, CH = 1920;
const mono = "'IBM Plex Mono', monospace";

function clearCanvas(ctx) {
  ctx.fillStyle = BG_COLOR;
  ctx.fillRect(0, 0, CW, CH);
}

function drawWatermark(ctx, y) {
  const wy = y || CH - 140;
  ctx.font = `300 22px ${mono}`;
  ctx.fillStyle = DIM_COLOR;
  ctx.textAlign = 'center';
  ctx.letterSpacing = '5px';
  ctx.fillText('WOODSHED', CW / 2, wy);
  ctx.letterSpacing = '0px';
}

function drawReflection(ctx, reflection, y, maxWidth) {
  if (!reflection) return y;
  y += 20;
  ctx.strokeStyle = '#ddd';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo((CW - maxWidth) / 2, y);
  ctx.lineTo((CW + maxWidth) / 2, y);
  ctx.stroke();
  y += 50;

  ctx.font = `italic 30px ${mono}`;
  ctx.fillStyle = FG_COLOR;
  ctx.textAlign = 'center';
  const quoteText = '\u201C' + reflection + '\u201D';
  const lines = getWrappedLines(ctx, quoteText, maxWidth);
  lines.forEach((line, i) => {
    ctx.fillText(line, CW / 2, y + i * 46);
  });
  return y + lines.length * 46 + 20;
}

function drawLabel(ctx, text, y) {
  ctx.font = `300 24px ${mono}`;
  ctx.fillStyle = DIM_COLOR;
  ctx.textAlign = 'center';
  ctx.letterSpacing = '6px';
  ctx.fillText(text, CW / 2, y);
  ctx.letterSpacing = '0px';
}

// ═══════════════════════════════════════════
// CARD 1: WEEK IN REVIEW
// ═══════════════════════════════════════════
function renderWeekCard(ctx, reflection) {
  clearCanvas(ctx);
  let y = 320;

  drawLabel(ctx, 'GUITAR \u00B7 WEEK IN PRACTICE', y);
  y += 120;

  const weekHrs = (appData.week.totalMinutes / 60).toFixed(1);
  ctx.font = `200 180px ${mono}`;
  ctx.fillStyle = FG_COLOR;
  ctx.textAlign = 'center';
  ctx.fillText(weekHrs, CW / 2, y);
  y += 30;

  ctx.font = `300 26px ${mono}`;
  ctx.fillStyle = DIM_COLOR;
  ctx.letterSpacing = '5px';
  ctx.fillText('HOURS THIS WEEK', CW / 2, y);
  ctx.letterSpacing = '0px';
  y += 80;

  const cellSize = 100;
  const cellGap = 16;
  const gridWidth = 7 * cellSize + 6 * cellGap;
  const gridX = (CW - gridWidth) / 2;

  const dayLabels = ['M', 'T', 'W', 'T', 'F', 'S', 'S'];
  ctx.font = `400 22px ${mono}`;
  ctx.fillStyle = DIM_COLOR;
  dayLabels.forEach((label, i) => {
    const cx = gridX + i * (cellSize + cellGap) + cellSize / 2;
    ctx.fillText(label, cx, y);
  });
  y += 24;

  if (appData.week && appData.week.days) {
    let activeDays = 0;
    let weekGigs = 0;
    appData.week.days.forEach((day, i) => {
      const cx = gridX + i * (cellSize + cellGap);
      const cy = y;

      if (day.isFuture) {
        ctx.fillStyle = '#e8e5de';
      } else if (day.hasGig) {
        ctx.fillStyle = GIG_COLOR;
        weekGigs++;
      } else {
        ctx.fillStyle = INTENSITY_COLORS[day.intensity] || INTENSITY_COLORS[0];
      }
      if (day.minutes > 0) activeDays++;

      if (day.hasGig && !day.isFuture) {
        ctx.beginPath();
        ctx.arc(cx + cellSize / 2, cy + cellSize / 2, cellSize / 2, 0, Math.PI * 2);
        ctx.fill();
      } else {
        roundRect(ctx, cx, cy, cellSize, cellSize, 8);
        ctx.fill();
      }

      if (!day.isFuture && day.minutes > 0) {
        const isLight = day.intensity <= 1 && !day.hasGig;
        ctx.font = `500 26px ${mono}`;
        ctx.fillStyle = isLight ? 'rgba(0,0,0,0.4)' : 'rgba(255,255,255,0.9)';
        ctx.textAlign = 'center';
        ctx.fillText(day.minutes.toString(), cx + cellSize / 2, cy + cellSize / 2 + 9);
      }
    });
    y += cellSize + 30;

    ctx.font = `400 22px ${mono}`;
    ctx.fillStyle = DIM_COLOR;
    ctx.textAlign = 'left';
    const gigStr = weekGigs > 0 ? ` \u00B7 ${weekGigs} gig${weekGigs !== 1 ? 's' : ''}` : '';
    ctx.fillText(`${activeDays} of 7 days${gigStr}`, gridX, y);
    ctx.textAlign = 'right';
    ctx.fillText(`${appData.streak} day streak`, gridX + gridWidth, y);
    y += 60;

    const topCat = appData.week.topCategory;
    if (topCat) {
      ctx.textAlign = 'center';
      ctx.font = `300 26px ${mono}`;
      ctx.fillStyle = DIM_COLOR;
      ctx.fillText(`mostly ${topCat} this week`, CW / 2, y);
      y += 50;
    }
  }

  y = drawReflection(ctx, reflection, y, gridWidth);
  drawWatermark(ctx);
}

// ═══════════════════════════════════════════
// CARD 2: THE GRIND (category breakdown)
// ═══════════════════════════════════════════
function renderGrindCard(ctx, reflection) {
  clearCanvas(ctx);
  let y = 280;

  drawLabel(ctx, 'GUITAR \u00B7 THE GRIND', y);
  y += 100;

  const monthHrs = parseFloat((appData.month.totalMinutes / 60).toFixed(1));
  ctx.font = `200 160px ${mono}`;
  ctx.fillStyle = FG_COLOR;
  ctx.textAlign = 'center';
  ctx.fillText(monthHrs.toString(), CW / 2, y);
  y += 30;

  ctx.font = `300 26px ${mono}`;
  ctx.fillStyle = DIM_COLOR;
  ctx.letterSpacing = '5px';
  ctx.fillText('HOURS IN ' + (appData.month.name || '--').toUpperCase(), CW / 2, y);
  ctx.letterSpacing = '0px';
  y += 100;

  const barX = 140;
  const barMaxW = CW - 280;
  const barH = 24;
  const barGap = 60;
  const breakdown = appData.categoryBreakdownMonth || appData.categoryBreakdown || {};
  const cats = Object.entries(breakdown).sort((a, b) => b[1] - a[1]);
  const maxMins = cats.length > 0 ? cats[0][1] : 1;

  cats.forEach((cat, i) => {
    const catName = cat[0];
    const mins = cat[1];
    const hrs = parseFloat((mins / 60).toFixed(1));
    const barW = Math.max((mins / maxMins) * barMaxW, 4);
    const cy = y + i * (barH + barGap);

    ctx.font = `400 24px ${mono}`;
    ctx.fillStyle = DIM_COLOR;
    ctx.textAlign = 'left';
    ctx.fillText(catName, barX, cy - 8);

    ctx.fillStyle = '#e8e5de';
    roundRect(ctx, barX, cy, barMaxW, barH, 4);
    ctx.fill();

    ctx.fillStyle = i === 0 ? '#1db954' : FG_COLOR;
    roundRect(ctx, barX, cy, barW, barH, 4);
    ctx.fill();

    ctx.font = `400 22px ${mono}`;
    ctx.fillStyle = DIM_COLOR;
    ctx.textAlign = 'right';
    ctx.fillText(hrs + 'h', CW - barX, cy + barH - 4);
  });

  y += cats.length * (barH + barGap) + 30;

  const weekHrs = parseFloat((appData.week.totalMinutes / 60).toFixed(1));
  ctx.font = `300 24px ${mono}`;
  ctx.fillStyle = DIM_COLOR;
  ctx.textAlign = 'center';
  ctx.fillText(`${weekHrs}h this week \u00B7 ${appData.streak} day streak`, CW / 2, y);
  y += 60;

  y = drawReflection(ctx, reflection, y, barMaxW);
  drawWatermark(ctx);
}

// ═══════════════════════════════════════════
// CARD 3: THE LONG GAME (year + grid)
// ═══════════════════════════════════════════
function renderStreakCard(ctx, reflection) {
  clearCanvas(ctx);
  let y = 280;

  drawLabel(ctx, 'GUITAR \u00B7 THE LONG GAME', y);
  y += 100;

  const yearHrs = Math.round((appData.year ? appData.year.totalMinutes : 0) / 60);
  ctx.font = `200 160px ${mono}`;
  ctx.fillStyle = FG_COLOR;
  ctx.textAlign = 'center';
  ctx.fillText(yearHrs.toString(), CW / 2, y);
  y += 30;

  ctx.font = `300 26px ${mono}`;
  ctx.fillStyle = DIM_COLOR;
  ctx.letterSpacing = '5px';
  ctx.fillText('HOURS IN ' + new Date().getFullYear(), CW / 2, y);
  ctx.letterSpacing = '0px';
  y += 80;

  // Three stat columns
  const monthHrs = parseFloat((appData.month.totalMinutes / 60).toFixed(1));
  const weekHrs = parseFloat((appData.week.totalMinutes / 60).toFixed(1));
  const statY = y;
  const colW = CW / 3;
  const statItems = [
    { num: weekHrs.toString(), label: 'THIS WEEK' },
    { num: appData.streak.toString(), label: 'DAY STREAK' },
    { num: monthHrs.toString(), label: 'IN ' + (appData.month.name || '--').toUpperCase() },
  ];
  statItems.forEach((s, i) => {
    const cx = colW / 2 + i * colW;
    ctx.font = `300 48px ${mono}`;
    ctx.fillStyle = FG_COLOR;
    ctx.textAlign = 'center';
    ctx.fillText(s.num, cx, statY);
    ctx.font = `300 18px ${mono}`;
    ctx.fillStyle = DIM_COLOR;
    ctx.letterSpacing = '3px';
    ctx.fillText(s.label, cx, statY + 28);
    ctx.letterSpacing = '0px';
  });
  y = statY + 80;

  // Contribution grid
  if (appData.grid && appData.grid.length > 0) {
    const gridPad = 80;
    const availW = CW - gridPad * 2;
    const cols = 52;
    const rows = 7;
    const cellGap = 2;
    const cellSize = Math.floor((availW - (cols - 1) * cellGap) / cols);
    const gridW = cols * cellSize + (cols - 1) * cellGap;
    const gridXStart = (CW - gridW) / 2;

    const monthLabels = ['J', 'F', 'M', 'A', 'M', 'J', 'J', 'A', 'S', 'O', 'N', 'D'];
    ctx.font = `400 16px ${mono}`;
    ctx.fillStyle = DIM_COLOR;
    ctx.textAlign = 'center';
    monthLabels.forEach((m, mi) => {
      const mx = gridXStart + (mi / 12) * gridW + gridW / 24;
      ctx.fillText(m, mx, y);
    });
    y += 16;

    for (let i = 0; i < Math.min(appData.grid.length, cols * rows); i++) {
      const col = Math.floor(i / rows);
      const row = i % rows;
      const cell = appData.grid[i];
      const cx = gridXStart + col * (cellSize + cellGap);
      const cy = y + row * (cellSize + cellGap);

      if (cell.hasGig) {
        ctx.fillStyle = GIG_COLOR;
      } else if (cell.intensity === -1) {
        ctx.fillStyle = '#eae7e0';
      } else {
        ctx.fillStyle = INTENSITY_COLORS[cell.intensity] || INTENSITY_COLORS[0];
      }
      ctx.fillRect(cx, cy, cellSize, cellSize);
    }

    y += rows * (cellSize + cellGap) + 24;

    // Legend
    ctx.font = `400 16px ${mono}`;
    ctx.fillStyle = DIM_COLOR;
    ctx.textAlign = 'right';
    ctx.fillText('less', gridXStart + gridW - 90, y);
    const legendColors = [INTENSITY_COLORS[0], INTENSITY_COLORS[1], INTENSITY_COLORS[2], INTENSITY_COLORS[3], INTENSITY_COLORS[4]];
    legendColors.forEach((c, ci) => {
      ctx.fillStyle = c;
      ctx.fillRect(gridXStart + gridW - 80 + ci * 14, y - 10, 10, 10);
    });
    ctx.fillStyle = DIM_COLOR;
    ctx.textAlign = 'left';
    ctx.fillText('more', gridXStart + gridW - 80 + 5 * 14 + 4, y);
    ctx.fillStyle = GIG_COLOR;
    ctx.fillRect(gridXStart + gridW - 80 + 5 * 14 + 50, y - 10, 10, 10);
    ctx.fillStyle = DIM_COLOR;
    ctx.fillText('gig', gridXStart + gridW - 80 + 5 * 14 + 66, y);
    y += 50;
  }

  y = drawReflection(ctx, reflection, y, CW - 160);
  drawWatermark(ctx);
}

// Save / Share
document.getElementById('save-image-btn').addEventListener('click', () => {
  const canvas = document.getElementById('share-canvas');
  const link = document.createElement('a');
  link.download = `woodshed-${selectedCardType}.png`;
  link.href = canvas.toDataURL('image/png');
  link.click();
  showToast('image saved');
});

document.getElementById('share-btn').addEventListener('click', async () => {
  const canvas = document.getElementById('share-canvas');
  try {
    const blob = await new Promise(r => canvas.toBlob(r, 'image/png'));
    const file = new File([blob], `woodshed-${selectedCardType}.png`, { type: 'image/png' });
    if (navigator.share && navigator.canShare({ files: [file] })) {
      await navigator.share({ files: [file] });
    } else {
      const link = document.createElement('a');
      link.download = `woodshed-${selectedCardType}.png`;
      link.href = URL.createObjectURL(blob);
      link.click();
      showToast('image saved (share not supported)');
    }
  } catch (err) {
    console.log('Share cancelled or failed');
  }
});


// ═══════════════════════════════════════════
// CANVAS DRAWING UTILS
// ═══════════════════════════════════════════
function roundRect(ctx, x, y, w, h, r) {
  ctx.beginPath();
  ctx.moveTo(x + r, y);
  ctx.lineTo(x + w - r, y);
  ctx.quadraticCurveTo(x + w, y, x + w, y + r);
  ctx.lineTo(x + w, y + h - r);
  ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
  ctx.lineTo(x + r, y + h);
  ctx.quadraticCurveTo(x, y + h, x, y + h - r);
  ctx.lineTo(x, y + r);
  ctx.quadraticCurveTo(x, y, x + r, y);
  ctx.closePath();
}

function getWrappedLines(ctx, text, maxWidth) {
  const words = text.split(' ');
  const lines = [];
  let line = '';
  for (const word of words) {
    const test = line + (line ? ' ' : '') + word;
    if (ctx.measureText(test).width > maxWidth && line) {
      lines.push(line);
      line = word;
    } else {
      line = test;
    }
  }
  if (line) lines.push(line);
  return lines;
}

function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
  const lines = getWrappedLines(ctx, text, maxWidth);
  lines.forEach((line, i) => {
    ctx.fillText(line, x, y + i * lineHeight);
  });
}

// ═══════════════════════════════════════════
// HELPERS
// ═══════════════════════════════════════════
function formatHours(minutes) {
  if (minutes < 60) return `${minutes}m`;
  const h = Math.floor(minutes / 60);
  const m = minutes % 60;
  return m > 0 ? `${h}h ${m}m` : `${h}h`;
}

function formatMinutes(minutes) {
  if (minutes < 60) return `${minutes}m`;
  const h = Math.floor(minutes / 60);
  const m = minutes % 60;
  return m > 0 ? `${h}h ${m}m` : `${h}h`;
}

function timeAgo(date) {
  const now = new Date();
  const diffMs = now - date;
  const diffMins = Math.floor(diffMs / 60000);
  const diffHrs = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);

  if (diffMins < 1) return 'just now';
  if (diffMins < 60) return `${diffMins}m ago`;
  if (diffHrs < 24) return `${diffHrs}h ago`;
  if (diffDays === 1) return '1d ago';
  return `${diffDays}d ago`;
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2000);
}

// ═══════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════
fetchStats();

// Register service worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').catch(() => {});
}
</script>
</body>
</html>
