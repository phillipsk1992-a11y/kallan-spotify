<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="theme-color" content="#f5f2eb">
<link rel="manifest" href="/manifest.json">
<title>woodshed</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&display=swap" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --bg: #f5f2eb;
  --fg: #1a1a1a;
  --dim: #888;
  --rule: #ccc;
  --green: #1db954;
  --gig: #e07a2f;
  --int-0: #e8e5de;
  --int-1: #c8dfc0;
  --int-2: #7db868;
  --int-3: #3d8b2a;
  --int-4: #1a5c0e;
}

html, body {
  font-family: 'IBM Plex Mono', monospace;
  background: var(--bg);
  color: var(--fg);
  min-height: 100vh;
  min-height: 100dvh;
  -webkit-font-smoothing: antialiased;
}

body {
  max-width: 480px;
  margin: 0 auto;
  padding: 20px 24px 100px;
  padding-top: env(safe-area-inset-top, 20px);
}

/* ─── Header ─── */
.app-header {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  margin-bottom: 24px;
  padding-top: 8px;
}

.app-name {
  font-size: 20px;
  font-weight: 600;
  letter-spacing: -0.5px;
  display: flex;
  align-items: center;
  gap: 4px;
}

.app-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--green);
  flex-shrink: 0;
  margin-top: 4px;
  animation: dot-pulse 2s ease-in-out infinite;
}

@keyframes dot-pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.25; }
}

.header-link {
  font-size: 12px;
  color: var(--dim);
  text-decoration: underline;
  text-underline-offset: 2px;
  cursor: pointer;
}

/* ─── Tabs ─── */
.tabs {
  display: flex;
  gap: 0;
  margin-bottom: 22px;
  border-bottom: 1px solid var(--rule);
}

.tabs button {
  font-family: inherit;
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: var(--dim);
  background: none;
  border: none;
  padding: 9px 16px 9px 0;
  border-bottom: 1.5px solid transparent;
  margin-bottom: -1px;
  cursor: pointer;
}

.tabs button.active {
  color: var(--fg);
  border-bottom-color: var(--fg);
}

/* ─── Divider ─── */
.divider {
  color: var(--rule);
  font-size: 11px;
  margin: 22px 0;
  overflow: hidden;
  white-space: nowrap;
  user-select: none;
}

.section-label {
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 2px;
  color: var(--dim);
  margin-bottom: 12px;
}

/* ─── Tab Content ─── */
.tab-content { display: none; }
.tab-content.active { display: block; }

/* ═══════════════════════════════════════ */
/* HOME TAB                               */
/* ═══════════════════════════════════════ */

.home-greeting {
  font-size: 18px;
  font-weight: 400;
  margin-bottom: 4px;
}

.home-date {
  font-size: 12px;
  color: var(--dim);
  margin-bottom: 26px;
}

/* Week visualisation */
.week-viz {
  display: flex;
  gap: 8px;
  justify-content: center;
  margin-bottom: 6px;
}

.week-viz .day-wrap {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 5px;
}

.week-viz .day-cell {
  width: 42px;
  height: 42px;
  border-radius: 3px;
}

.week-viz .day-cell.future {
  background: var(--int-0);
  border: 1.5px dashed var(--rule);
}

.week-viz .day-cell.gig-day {
  border-radius: 50%;
}

.week-viz .day-name {
  font-size: 10px;
  color: var(--dim);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* Status lines */
.status-line {
  display: flex;
  align-items: center;
  padding: 11px 0;
  border-bottom: 1px solid #eae7e0;
  font-size: 13px;
}

.status-line .dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  margin-right: 12px;
  flex-shrink: 0;
}

.status-line .dot.green {
  background: var(--green);
  box-shadow: 0 0 6px rgba(29,185,84,0.4);
}

.status-line .dot.orange { background: var(--gig); }
.status-line .dot.grey { background: #bbb; }

.status-line .status-label {
  width: 90px;
  color: var(--dim);
  font-size: 12px;
}

.status-line .status-value { flex: 1; }

/* Home CTA */
.home-cta {
  display: block;
  width: 100%;
  background: var(--fg);
  color: var(--bg);
  border: none;
  font-family: inherit;
  font-size: 13px;
  text-transform: uppercase;
  letter-spacing: 2px;
  padding: 16px;
  cursor: pointer;
  text-align: center;
  margin-top: 8px;
}

.home-footer {
  text-align: center;
  font-size: 11px;
  color: #bbb;
  margin-top: 24px;
  line-height: 1.7;
  font-style: italic;
}

/* ═══════════════════════════════════════ */
/* LOG TAB                                */
/* ═══════════════════════════════════════ */

.category-grid {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 7px;
  margin-bottom: 10px;
}

.cat-btn {
  background: transparent;
  border: 1px solid var(--rule);
  font-family: inherit;
  font-size: 13px;
  padding: 15px 6px;
  text-align: center;
  color: var(--fg);
  cursor: pointer;
  transition: background 0.15s, color 0.15s;
}

.cat-btn.selected {
  background: var(--fg);
  color: var(--bg);
  border-color: var(--fg);
}

.gig-btn {
  width: 100%;
  background: transparent;
  border: 1px solid var(--gig);
  font-family: inherit;
  font-size: 13px;
  padding: 15px 6px;
  text-align: center;
  color: var(--gig);
  margin-bottom: 22px;
  cursor: pointer;
  transition: background 0.15s, color 0.15s;
}

.gig-btn.selected {
  background: var(--gig);
  color: var(--bg);
}

/* Venue field */
.venue-field {
  width: 100%;
  background: transparent;
  border: 1px solid var(--gig);
  font-family: inherit;
  font-size: 13px;
  padding: 11px 12px;
  color: var(--fg);
  margin-bottom: 14px;
  display: none;
}

.venue-field::placeholder { color: #d4a57a; }
.venue-field:focus { outline: none; border-color: var(--gig); }
.venue-field.visible { display: block; }

/* Duration controls */
.duration-row {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 20px;
  margin-bottom: 10px;
}

.dur-btn {
  width: 42px;
  height: 42px;
  border: 1px solid var(--rule);
  background: transparent;
  font-family: inherit;
  font-size: 20px;
  color: var(--fg);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
}

.dur-display {
  font-size: 38px;
  font-weight: 300;
  min-width: 110px;
  text-align: center;
}

.dur-display span {
  font-size: 14px;
  color: var(--dim);
  font-weight: 400;
}

.quick-mins {
  display: flex;
  justify-content: center;
  gap: 8px;
  margin-bottom: 18px;
}

.quick-mins button {
  font-family: inherit;
  font-size: 11px;
  color: var(--dim);
  border: 1px solid #ddd;
  padding: 5px 11px;
  background: transparent;
  cursor: pointer;
  transition: border-color 0.15s;
}

.quick-mins button:active {
  border-color: var(--fg);
  color: var(--fg);
}

/* Notes field */
.notes-field {
  width: 100%;
  background: transparent;
  border: 1px solid var(--rule);
  font-family: inherit;
  font-size: 13px;
  padding: 11px 12px;
  color: var(--fg);
  margin-bottom: 14px;
  resize: none;
}

.notes-field::placeholder { color: #b0ada6; }
.notes-field:focus { outline: none; border-color: var(--fg); }

/* Log button */
.log-btn {
  width: 100%;
  background: var(--fg);
  color: var(--bg);
  border: none;
  font-family: inherit;
  font-size: 13px;
  text-transform: uppercase;
  letter-spacing: 2px;
  padding: 15px;
  cursor: pointer;
  transition: opacity 0.15s;
}

.log-btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

.log-btn.success {
  background: var(--int-3);
}

/* Today entries */
.today-entry {
  display: flex;
  justify-content: space-between;
  font-size: 13px;
  padding: 7px 0;
  border-bottom: 1px solid #eae7e0;
}

.today-entry .entry-cat { color: var(--dim); }
.today-entry .entry-dur { font-weight: 500; }
.today-entry .entry-gig { color: var(--gig); }

.today-total {
  display: flex;
  justify-content: space-between;
  font-size: 13px;
  padding: 9px 0 0;
  font-weight: 600;
}

/* ═══════════════════════════════════════ */
/* STATS TAB                              */
/* ═══════════════════════════════════════ */

.stats-row {
  display: flex;
  justify-content: space-around;
  text-align: center;
  margin-bottom: 24px;
}

.stats-top-row {
  padding-top: 12px;
  margin-bottom: 28px;
}

.stats-top-row .stat-item-num {
  font-size: 28px;
  font-weight: 300;
}

.stats-top-row .stat-item-label {
  font-size: 10px;
}

.stat-item .stat-item-num {
  font-size: 24px;
  font-weight: 400;
}

.stat-item .stat-item-label {
  font-size: 10px;
  color: var(--dim);
  text-transform: uppercase;
  letter-spacing: 1.5px;
  margin-top: 3px;
}

/* Grid header */
.grid-header {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  margin-bottom: 8px;
}

.grid-header .section-label { margin-bottom: 0; }

.share-link {
  font-size: 11px;
  color: var(--dim);
  text-decoration: underline;
  text-underline-offset: 2px;
  cursor: pointer;
  background: none;
  border: none;
  font-family: inherit;
}

/* Month labels */
.grid-months {
  display: flex;
  justify-content: space-between;
  font-size: 9px;
  color: var(--dim);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 4px;
  padding: 0 1px;
}

/* Contribution grid */
.streak-grid {
  display: grid;
  grid-template-columns: repeat(52, 1fr);
  grid-template-rows: repeat(7, 1fr);
  grid-auto-flow: column;
  gap: 2px;
}

.streak-cell {
  aspect-ratio: 1;
  border-radius: 1px;
  min-width: 0;
}

.streak-cell.em { background: var(--int-0); }
.streak-cell.lt { background: var(--int-1); }
.streak-cell.md { background: var(--int-2); }
.streak-cell.hv { background: var(--int-3); }
.streak-cell.it { background: var(--int-4); }
.streak-cell.gi { background: var(--gig); border-radius: 50%; }
.streak-cell.future { opacity: 0.3; }

.grid-legend {
  display: flex;
  align-items: center;
  justify-content: flex-end;
  gap: 3px;
  margin-top: 6px;
  font-size: 9px;
  color: var(--dim);
}

.grid-legend .swatch {
  width: 8px;
  height: 8px;
  border-radius: 1px;
}

.grid-legend .swatch.gig-swatch { border-radius: 50%; }

/* Category bars */
.cat-bar-row {
  display: flex;
  align-items: center;
  margin-bottom: 9px;
}

.cat-bar-label {
  width: 82px;
  color: var(--dim);
  font-size: 12px;
}

.cat-bar-track {
  flex: 1;
  height: 6px;
  background: var(--int-0);
  margin: 0 10px;
}

.cat-bar-fill {
  height: 100%;
  background: var(--fg);
  transition: width 0.4s ease;
}

.cat-bar-fill.top { background: var(--green); }

.cat-bar-hours {
  font-size: 11px;
  color: var(--dim);
  width: 34px;
  text-align: right;
}

/* Gig entries */
.gig-entry {
  padding: 12px 0;
  border-bottom: 1px solid #eae7e0;
}

.gig-entry .gig-top {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  margin-bottom: 3px;
}

.gig-entry .gig-venue {
  font-size: 13px;
  font-weight: 500;
}

.gig-entry .gig-date {
  font-size: 12px;
  color: var(--dim);
}

.gig-entry .gig-detail {
  font-size: 12px;
  color: var(--dim);
}

.gig-dot {
  display: inline-block;
  width: 6px;
  height: 6px;
  background: var(--gig);
  border-radius: 50%;
  margin-right: 7px;
  vertical-align: middle;
}

.stats-footer {
  text-align: center;
  font-size: 11px;
  color: #bbb;
  margin-top: 14px;
  line-height: 1.6;
}

/* ═══════════════════════════════════════ */
/* SHARE FLOW                             */
/* ═══════════════════════════════════════ */

#share-view { display: none; }
#share-view.active { display: block; }

.share-back {
  font-size: 10px;
  color: var(--dim);
  text-decoration: underline;
  text-underline-offset: 2px;
  cursor: pointer;
  background: none;
  border: none;
  font-family: inherit;
}

.reflect-prompt {
  font-size: 14px;
  color: var(--fg);
  margin-bottom: 16px;
  line-height: 1.5;
}

.reflect-input {
  width: 100%;
  background: transparent;
  border: 1px solid var(--rule);
  font-family: inherit;
  font-size: 13px;
  padding: 14px;
  color: var(--fg);
  resize: none;
  line-height: 1.5;
}

.reflect-input::placeholder { color: #b0ada6; }
.reflect-input:focus { outline: none; border-color: var(--fg); }

.skip-link {
  font-size: 11px;
  color: var(--dim);
  text-decoration: underline;
  text-underline-offset: 2px;
  cursor: pointer;
  text-align: right;
  display: block;
  margin-top: 10px;
  background: none;
  border: none;
  font-family: inherit;
  margin-left: auto;
}

/* Preview */
.preview-label {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 2px;
  color: var(--dim);
  margin-bottom: 8px;
}

/* Card type selector */
.card-type-selector {
  display: flex;
  gap: 8px;
  margin-bottom: 14px;
}

.card-type-btn {
  flex: 1;
  background: transparent;
  border: 1px solid var(--rule);
  font-family: inherit;
  padding: 14px 8px;
  cursor: pointer;
  text-align: center;
  transition: all 0.15s;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
  color: var(--fg);
}

.card-type-btn.selected {
  background: var(--fg);
  color: var(--bg);
  border-color: var(--fg);
}

.card-type-icon {
  font-size: 18px;
  line-height: 1;
}

.card-type-name {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 1.5px;
}

.card-type-desc {
  font-size: 12px;
  color: var(--dim);
  text-align: center;
  margin-bottom: 8px;
  font-style: italic;
}

/* Card preview */
.card-preview-container {
  margin-bottom: 16px;
}

.card-preview-container canvas {
  width: 100%;
  border: 1px solid var(--rule);
}

.generate-btn {
  width: 100%;
  background: var(--fg);
  color: var(--bg);
  border: none;
  font-family: inherit;
  font-size: 13px;
  text-transform: uppercase;
  letter-spacing: 2px;
  padding: 15px;
  cursor: pointer;
}

/* Card view */
#card-view { display: none; }
#card-view.active { display: block; }

/* Share actions */
.share-actions {
  display: flex;
  gap: 8px;
  margin-top: 16px;
}

.share-action-btn {
  flex: 1;
  background: transparent;
  border: 1px solid var(--rule);
  font-family: inherit;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  padding: 12px;
  color: var(--fg);
  text-align: center;
  cursor: pointer;
}

.share-action-btn.primary {
  background: var(--fg);
  color: var(--bg);
  border-color: var(--fg);
}

.share-size {
  text-align: center;
  font-size: 11px;
  color: var(--dim);
  margin-top: 14px;
}

/* ─── Toast ─── */
.toast {
  position: fixed;
  bottom: 80px;
  left: 50%;
  transform: translateX(-50%) translateY(20px);
  background: var(--fg);
  color: var(--bg);
  font-family: inherit;
  font-size: 12px;
  letter-spacing: 1px;
  padding: 12px 24px;
  opacity: 0;
  transition: opacity 0.3s, transform 0.3s;
  pointer-events: none;
  z-index: 100;
}

.toast.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}

/* ─── Loading ─── */
.loading {
  text-align: center;
  font-size: 10px;
  color: var(--dim);
  padding: 40px 0;
  letter-spacing: 1px;
}

/* ─── Canvas (offscreen) ─── */
#share-canvas { display: none; }

/* Focus states */
input:focus, textarea:focus, button:focus { outline: none; }
</style>
</head>
<body>

<!-- App Header -->
<div class="app-header">
  <div class="app-name"><span class="app-dot"></span>woodshed</div>
  <div class="header-link" id="header-link" style="display:none;"></div>
</div>

<!-- Tab Navigation -->
<div class="tabs" id="main-tabs">
  <button class="active" data-tab="home">home</button>
  <button data-tab="log">log</button>
  <button data-tab="stats">stats</button>
</div>

<!-- ═══════════════════════════════════ HOME ═══════════════════════════════════ -->
<div class="tab-content active" id="tab-home">
  <div class="home-greeting" id="greeting"></div>
  <div class="home-date" id="home-date"></div>

  <div class="week-viz" id="week-viz"></div>

  <div class="divider">&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;</div>

  <div id="status-lines"></div>

  <div class="divider">&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;</div>

  <button class="home-cta" id="home-cta">log session</button>

  <div class="home-footer">"the woodshed is where<br>the work gets done."</div>
</div>

<!-- ═══════════════════════════════════ LOG ═══════════════════════════════════ -->
<div class="tab-content" id="tab-log">
  <div class="section-label">Category</div>
  <div class="category-grid" id="cat-grid">
    <button class="cat-btn" data-cat="technique">technique</button>
    <button class="cat-btn" data-cat="reading">reading</button>
    <button class="cat-btn" data-cat="chords">chords</button>
    <button class="cat-btn" data-cat="scales">scales</button>
    <button class="cat-btn" data-cat="tunes">tunes</button>
    <button class="cat-btn" data-cat="theory">theory</button>
  </div>
  <button class="gig-btn" id="gig-btn">&#9670; log a gig</button>
  <input type="text" class="venue-field" id="venue-field" placeholder="venue name">

  <div class="section-label">Duration</div>
  <div class="duration-row">
    <button class="dur-btn" id="dur-minus">&minus;</button>
    <div class="dur-display"><span id="dur-value">20</span> <span>min</span></div>
    <button class="dur-btn" id="dur-plus">+</button>
  </div>
  <div class="quick-mins" id="quick-mins">
    <button data-min="5">5</button>
    <button data-min="10">10</button>
    <button data-min="15">15</button>
    <button data-min="20">20</button>
    <button data-min="30">30</button>
    <button data-min="45">45</button>
    <button data-min="60">60</button>
  </div>

  <textarea class="notes-field" id="notes-field" rows="1" placeholder="notes (optional)"></textarea>
  <button class="log-btn" id="log-btn">log</button>

  <div class="divider">&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;</div>
  <div class="section-label">Today</div>
  <div id="today-entries"></div>
</div>

<!-- ═══════════════════════════════════ STATS ═══════════════════════════════════ -->
<div class="tab-content" id="tab-stats">
  <div class="stats-row stats-top-row">
    <div class="stat-item">
      <div class="stat-item-num" id="week-hours">--</div>
      <div class="stat-item-label">this week</div>
    </div>
    <div class="stat-item">
      <div class="stat-item-num" id="month-hours">--</div>
      <div class="stat-item-label" id="month-label">in --</div>
    </div>
    <div class="stat-item">
      <div class="stat-item-num" id="year-hours">--</div>
      <div class="stat-item-label">this year</div>
    </div>
  </div>

  <div class="divider">&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;</div>

  <div class="grid-header">
    <div class="section-label" id="grid-year">2026</div>
    <button class="share-link" id="share-week-btn">share &#8599;</button>
  </div>
  <div class="grid-months">
    <span>J</span><span>F</span><span>M</span><span>A</span><span>M</span><span>J</span><span>J</span><span>A</span><span>S</span><span>O</span><span>N</span><span>D</span>
  </div>
  <div class="streak-grid" id="streak-grid"></div>
  <div class="grid-legend">
    <span>less</span>
    <div class="swatch" style="background: var(--int-0);"></div>
    <div class="swatch" style="background: var(--int-1);"></div>
    <div class="swatch" style="background: var(--int-2);"></div>
    <div class="swatch" style="background: var(--int-3);"></div>
    <div class="swatch" style="background: var(--int-4);"></div>
    <span>more</span>
    <span style="margin: 0 4px;">&middot;</span>
    <div class="swatch gig-swatch" style="background: var(--gig);"></div>
    <span>gig</span>
  </div>

  <div class="divider">&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;</div>
  <div class="section-label">Breakdown</div>
  <div id="category-bars"></div>

  <div class="divider">&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;</div>
  <div class="section-label">Recent Gigs</div>
  <div id="recent-gigs"></div>

  <div class="stats-footer">practice logged manually.<br>accountability through transparency.</div>
</div>

<!-- ═══════════════════════════════════ SHARE FLOW ═══════════════════════════════════ -->
<div id="share-view">
  <div class="section-label">Share your progress</div>

  <div class="card-type-selector">
    <button class="card-type-btn selected" data-card="week">
      <span class="card-type-icon">&#9632;</span>
      <span class="card-type-name">week</span>
    </button>
    <button class="card-type-btn" data-card="month">
      <span class="card-type-icon">&#9612;</span>
      <span class="card-type-name">month</span>
    </button>
    <button class="card-type-btn" data-card="year">
      <span class="card-type-icon">&#9617;</span>
      <span class="card-type-name">year</span>
    </button>
  </div>

  <div class="card-type-desc" id="card-type-desc">i showed up</div>

  <div class="divider">&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;</div>

  <div class="reflect-prompt">Anything worth<br>remembering?</div>
  <textarea class="reflect-input" id="reflect-input" rows="3" placeholder="optional -- skip if nothing comes to mind"></textarea>
  <button class="skip-link" id="skip-reflect">skip &#8594;</button>

  <div class="divider">&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;</div>

  <button class="generate-btn" id="generate-btn">generate card</button>
</div>

<!-- ═══════════════════════════════════ CARD VIEW ═══════════════════════════════════ -->
<div id="card-view">
  <div class="card-preview-container" id="card-preview-container"></div>

  <div class="share-actions">
    <button class="share-action-btn" id="save-image-btn">save image</button>
    <button class="share-action-btn primary" id="share-btn">share</button>
  </div>
  <div class="share-size">1080 &times; 1920</div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Offscreen canvas for card generation -->
<canvas id="share-canvas" width="1080" height="1920"></canvas>

<script>
// ═══════════════════════════════════════════
// CONFIG
// ═══════════════════════════════════════════
const API_URL = '/api/practice-log';
const API_SECRET = 'kallanpracticelog92'; // Set via env or replace

const INTENSITY_COLORS = ['#e8e5de', '#c8dfc0', '#7db868', '#3d8b2a', '#1a5c0e'];
const GIG_COLOR = '#e07a2f';
const BG_COLOR = '#f5f2eb';
const FG_COLOR = '#1a1a1a';
const DIM_COLOR = '#888888';

// ═══════════════════════════════════════════
// STATE
// ═══════════════════════════════════════════
let appData = null;
let selectedCategory = null;
let isGigMode = false;
let duration = 20;
let currentView = 'main'; // main | share | card

// ═══════════════════════════════════════════
// API
// ═══════════════════════════════════════════
async function fetchStats() {
  try {
    const resp = await fetch(API_URL + '?tz=' + new Date().getTimezoneOffset(), {});
    if (!resp.ok) {
      const body = await resp.text();
      console.error(`API ${resp.status}: ${body}`);
      showToast(`api error: ${resp.status}`);
      return;
    }
    appData = await resp.json();
    renderAll();
  } catch (err) {
    console.error('Failed to fetch stats:', err);
    showToast('could not reach api');
  }
}

async function logEntry(category, minutes, notes, type, venue) {
  try {
    const resp = await fetch(API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${API_SECRET}`,
      },
      body: JSON.stringify({ category, minutes, notes, type, venue }),
    });
    if (!resp.ok) throw new Error('API error');
    return await resp.json();
  } catch (err) {
    console.error('Failed to log entry:', err);
    throw err;
  }
}

// ═══════════════════════════════════════════
// RENDERING
// ═══════════════════════════════════════════
function renderAll() {
  if (!appData) return;
  renderHome();
  renderLog();
  renderStats();
}

// ─── Home Tab ───
function renderHome() {
  // Greeting
  const hour = new Date().getHours();
  let greet = 'Good evening.';
  if (hour < 12) greet = 'Good morning.';
  else if (hour < 17) greet = 'Good afternoon.';
  document.getElementById('greeting').textContent = greet;

  // Date + streak
  const now = new Date();
  const options = { weekday: 'long', month: 'long', day: 'numeric' };
  const dateStr = now.toLocaleDateString('en-US', options);
  const streakStr = appData.streak > 0 ? ` · Day ${appData.streak} of your streak` : '';
  document.getElementById('home-date').textContent = dateStr + streakStr;

  // Week visualisation
  const weekViz = document.getElementById('week-viz');
  weekViz.innerHTML = '';
  if (appData.week && appData.week.days) {
    appData.week.days.forEach(day => {
      const wrap = document.createElement('div');
      wrap.className = 'day-wrap';

      const cell = document.createElement('div');
      cell.className = 'day-cell';
      if (day.isFuture) {
        cell.classList.add('future');
      } else if (day.hasGig) {
        cell.classList.add('gig-day');
        cell.style.background = GIG_COLOR;
      } else {
        cell.style.background = INTENSITY_COLORS[day.intensity] || INTENSITY_COLORS[0];
      }

      const name = document.createElement('div');
      name.className = 'day-name';
      name.textContent = day.dayLabel;

      wrap.appendChild(cell);
      wrap.appendChild(name);
      weekViz.appendChild(wrap);
    });
  }

  // Status lines
  const statusEl = document.getElementById('status-lines');
  statusEl.innerHTML = '';

  // Last practiced
  if (appData.lastPractice) {
    const ts = new Date(appData.lastPractice.timestamp);
    const ago = timeAgo(ts);
    addStatusLine(statusEl, 'green', 'practiced', `${ago} · ${appData.lastPractice.minutes}m ${appData.lastPractice.category}`);
  }

  // Last gig
  if (appData.lastGig) {
    const ts = new Date(appData.lastGig.timestamp);
    const ago = timeAgo(ts);
    addStatusLine(statusEl, 'orange', 'gigged', `${ago} · ${appData.lastGig.venue || 'gig'} · ${appData.lastGig.minutes}m`);
  }

  // This week
  if (appData.week) {
    const hrs = formatHours(appData.week.totalMinutes);
    const sessions = appData.week.sessionCount;
    addStatusLine(statusEl, 'grey', 'this week', `${hrs} · ${sessions} sessions`);
  }

  // This month
  if (appData.month) {
    const hrs = formatHours(appData.month.totalMinutes);
    const gigs = appData.month.gigCount;
    addStatusLine(statusEl, 'grey', 'this month', `${hrs} · ${gigs} gig${gigs !== 1 ? 's' : ''}`);
  }
}

function addStatusLine(parent, dotClass, label, value) {
  const line = document.createElement('div');
  line.className = 'status-line';
  line.innerHTML = `
    <div class="dot ${dotClass}"></div>
    <span class="status-label">${label}</span>
    <span class="status-value">${value}</span>
  `;
  parent.appendChild(line);
}

// ─── Log Tab ───
function renderLog() {
  const entriesEl = document.getElementById('today-entries');
  entriesEl.innerHTML = '';

  if (!appData.today || appData.today.entries.length === 0) {
    entriesEl.innerHTML = '<div style="font-size:12px;color:var(--dim);padding:10px 0;">no entries yet today</div>';
    return;
  }

  appData.today.entries.forEach(e => {
    const row = document.createElement('div');
    row.className = 'today-entry';
    if (e.type === 'gig') {
      row.innerHTML = `
        <span class="entry-gig">◆ ${e.venue || 'gig'}</span>
        <span class="entry-dur">${e.minutes}m</span>
      `;
    } else {
      row.innerHTML = `
        <span class="entry-cat">${e.category}</span>
        <span class="entry-dur">${e.minutes}m</span>
      `;
    }
    entriesEl.appendChild(row);
  });

  // Total
  const total = document.createElement('div');
  total.className = 'today-total';
  total.innerHTML = `<span>total</span><span>${formatMinutes(appData.today.totalMinutes)}</span>`;
  entriesEl.appendChild(total);
}

// ─── Stats Tab ───
function renderStats() {
  // Week
  document.getElementById('week-hours').textContent = formatMinutes(appData.week.totalMinutes);

  // Month with month name
  document.getElementById('month-hours').textContent = formatMinutes(appData.month.totalMinutes);
  document.getElementById('month-label').textContent = 'in ' + (appData.month.name || '--');

  // Year
  const yearMin = appData.year ? appData.year.totalMinutes : 0;
  document.getElementById('year-hours').textContent = formatMinutes(yearMin);

  // Year label
  document.getElementById('grid-year').textContent = new Date().getFullYear();

  // Contribution grid
  const gridEl = document.getElementById('streak-grid');
  gridEl.innerHTML = '';
  if (appData.grid) {
    appData.grid.forEach(cell => {
      const el = document.createElement('div');
      el.className = 'streak-cell';
      if (cell.hasGig) {
        el.classList.add('gi');
      } else if (cell.intensity === -1) {
        el.classList.add('em', 'future');
      } else if (cell.intensity === 0) {
        el.classList.add('em');
      } else if (cell.intensity === 1) {
        el.classList.add('lt');
      } else if (cell.intensity === 2) {
        el.classList.add('md');
      } else if (cell.intensity === 3) {
        el.classList.add('hv');
      } else {
        el.classList.add('it');
      }
      gridEl.appendChild(el);
    });
  }

  // Category breakdown
  const barsEl = document.getElementById('category-bars');
  barsEl.innerHTML = '';
  const categories = appData.categoryBreakdownMonth || {};
  const sorted = Object.entries(categories).sort((a, b) => b[1] - a[1]);
  const maxMins = sorted.length > 0 ? sorted[0][1] : 1;

  sorted.forEach(([ cat, mins ], i) => {
    const pct = Math.round((mins / maxMins) * 100);
    const hrs = Math.round(mins / 60);
    const row = document.createElement('div');
    row.className = 'cat-bar-row';
    row.innerHTML = `
      <span class="cat-bar-label">${cat}</span>
      <div class="cat-bar-track"><div class="cat-bar-fill${i === 0 ? ' top' : ''}" style="width:${pct}%;"></div></div>
      <span class="cat-bar-hours">${hrs}h</span>
    `;
    barsEl.appendChild(row);
  });

  // Recent gigs
  const gigsEl = document.getElementById('recent-gigs');
  gigsEl.innerHTML = '';
  if (appData.recentGigs && appData.recentGigs.length > 0) {
    appData.recentGigs.forEach(g => {
      const d = new Date(g.timestamp);
      const dateStr = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      const durStr = formatMinutes(g.minutes);
      const entry = document.createElement('div');
      entry.className = 'gig-entry';
      entry.innerHTML = `
        <div class="gig-top">
          <span class="gig-venue"><span class="gig-dot"></span>${g.venue || 'Gig'}</span>
          <span class="gig-date">${dateStr}</span>
        </div>
        <div class="gig-detail">${g.notes ? g.notes + ' · ' : ''}${durStr}</div>
      `;
      gigsEl.appendChild(entry);
    });
  } else {
    gigsEl.innerHTML = '<div style="font-size:12px;color:var(--dim);padding:10px 0;">no gigs logged yet</div>';
  }
}

// ═══════════════════════════════════════════
// TAB NAVIGATION
// ═══════════════════════════════════════════
document.querySelectorAll('#main-tabs button').forEach(btn => {
  btn.addEventListener('click', () => {
    if (currentView !== 'main') {
      showMainView();
    }
    switchTab(btn.dataset.tab);
  });
});

function switchTab(tabName) {
  document.querySelectorAll('#main-tabs button').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));

  document.querySelector(`#main-tabs button[data-tab="${tabName}"]`).classList.add('active');
  document.getElementById(`tab-${tabName}`).classList.add('active');
}

// Home CTA → Log tab
document.getElementById('home-cta').addEventListener('click', () => {
  switchTab('log');
});

// ═══════════════════════════════════════════
// LOG INTERACTION
// ═══════════════════════════════════════════

// Category selection
document.querySelectorAll('.cat-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    selectedCategory = btn.dataset.cat;
    isGigMode = false;
    document.getElementById('gig-btn').classList.remove('selected');
    document.getElementById('venue-field').classList.remove('visible');
  });
});

// Gig button
document.getElementById('gig-btn').addEventListener('click', () => {
  isGigMode = !isGigMode;
  document.getElementById('gig-btn').classList.toggle('selected', isGigMode);
  document.getElementById('venue-field').classList.toggle('visible', isGigMode);
  if (isGigMode) {
    document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('selected'));
    selectedCategory = null;
    document.getElementById('venue-field').focus();
  }
});

// Duration
document.getElementById('dur-minus').addEventListener('click', () => {
  duration = Math.max(5, duration - 5);
  document.getElementById('dur-value').textContent = duration;
});

document.getElementById('dur-plus').addEventListener('click', () => {
  duration = Math.min(480, duration + 5);
  document.getElementById('dur-value').textContent = duration;
});

document.querySelectorAll('#quick-mins button').forEach(btn => {
  btn.addEventListener('click', () => {
    duration = parseInt(btn.dataset.min);
    document.getElementById('dur-value').textContent = duration;
  });
});

// Log submission
document.getElementById('log-btn').addEventListener('click', async () => {
  const btn = document.getElementById('log-btn');
  const notes = document.getElementById('notes-field').value.trim();
  const venue = document.getElementById('venue-field').value.trim();

  if (isGigMode) {
    if (!venue) {
      showToast('enter a venue name');
      return;
    }
    btn.disabled = true;
    btn.textContent = 'logging...';
    try {
      await logEntry('gig', duration, notes, 'gig', venue);
      btn.textContent = 'logged';
      btn.classList.add('success');
      document.getElementById('venue-field').value = '';
      document.getElementById('notes-field').value = '';
      isGigMode = false;
      document.getElementById('gig-btn').classList.remove('selected');
      document.getElementById('venue-field').classList.remove('visible');
      await fetchStats();
      setTimeout(() => {
        btn.textContent = 'log';
        btn.classList.remove('success');
        btn.disabled = false;
      }, 1200);
    } catch {
      btn.textContent = 'error';
      setTimeout(() => { btn.textContent = 'log'; btn.disabled = false; }, 1500);
    }
  } else {
    if (!selectedCategory) {
      showToast('pick a category');
      return;
    }
    btn.disabled = true;
    btn.textContent = 'logging...';
    try {
      await logEntry(selectedCategory, duration, notes, 'practice', '');
      btn.textContent = 'logged';
      btn.classList.add('success');
      document.getElementById('notes-field').value = '';
      await fetchStats();
      setTimeout(() => {
        btn.textContent = 'log';
        btn.classList.remove('success');
        btn.disabled = false;
      }, 1200);
    } catch {
      btn.textContent = 'error';
      setTimeout(() => { btn.textContent = 'log'; btn.disabled = false; }, 1500);
    }
  }
});

// ═══════════════════════════════════════════
// SHARE FLOW
// ═══════════════════════════════════════════
let selectedCardType = 'week';
const cardDescriptions = {
  week: 'i showed up',
  month: 'what i worked on',
  year: 'the long game',
};

// Card type selector
document.querySelectorAll('.card-type-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.card-type-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    selectedCardType = btn.dataset.card;
    document.getElementById('card-type-desc').textContent = cardDescriptions[selectedCardType];
  });
});

document.getElementById('share-week-btn').addEventListener('click', () => {
  showShareView();
});

function showShareView() {
  currentView = 'share';
  document.getElementById('main-tabs').style.display = 'none';
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.getElementById('share-view').classList.add('active');
  document.getElementById('card-view').classList.remove('active');

  const link = document.getElementById('header-link');
  link.style.display = 'inline';
  link.textContent = '← stats';
  link.onclick = () => showMainView();
}

document.getElementById('skip-reflect').addEventListener('click', () => {
  document.getElementById('reflect-input').value = '';
  generateCard();
});

document.getElementById('generate-btn').addEventListener('click', () => {
  generateCard();
});

function generateCard() {
  currentView = 'card';
  document.getElementById('share-view').classList.remove('active');
  document.getElementById('card-view').classList.add('active');

  const link = document.getElementById('header-link');
  link.textContent = '← back';
  link.onclick = () => showShareView();

  if (!appData) return;

  const reflection = document.getElementById('reflect-input').value.trim();
  const canvas = document.getElementById('share-canvas');
  const ctx = canvas.getContext('2d');

  if (selectedCardType === 'week') {
    renderWeekCard(ctx, reflection);
  } else if (selectedCardType === 'month') {
    renderMonthCard(ctx, reflection);
  } else if (selectedCardType === 'year') {
    renderYearCard(ctx, reflection);
  }

  // Show canvas preview
  const container = document.getElementById('card-preview-container');
  container.innerHTML = '';
  const preview = document.createElement('canvas');
  preview.width = 1080;
  preview.height = 1920;
  preview.getContext('2d').drawImage(canvas, 0, 0);
  container.appendChild(preview);
}

function showMainView() {
  currentView = 'main';
  document.getElementById('main-tabs').style.display = 'flex';
  document.getElementById('share-view').classList.remove('active');
  document.getElementById('card-view').classList.remove('active');
  document.getElementById('header-link').style.display = 'none';
  switchTab('stats');
}


// ═══════════════════════════════════════════
// CANVAS HELPERS
// ═══════════════════════════════════════════
const CW = 1080, CH = 1920;
const mono = "'IBM Plex Mono', monospace";

function clearCanvas(ctx) {
  ctx.fillStyle = BG_COLOR;
  ctx.fillRect(0, 0, CW, CH);

  // Border inset from edges
  ctx.strokeStyle = '#b0ada6';
  ctx.lineWidth = 3;
  ctx.strokeRect(40, 40, CW - 80, CH - 80);
}

function fmtMin(totalMin) {
  if (totalMin < 60) return totalMin + 'm';
  const h = Math.floor(totalMin / 60);
  const m = totalMin % 60;
  return m > 0 ? h + 'h ' + m + 'm' : h + 'h';
}

function drawHeader(ctx) {
  const logoText = 'woodshed';
  ctx.font = `600 34px ${mono}`;
  ctx.letterSpacing = '1px';
  ctx.textAlign = 'left';
  const textW = ctx.measureText(logoText).width;
  const dotR = 6;
  const dotGap = 8;
  const totalW = dotR * 2 + dotGap + textW;
  const startX = (CW - totalW) / 2;

  // Green accent dot — vertically centered with text x-height
  ctx.fillStyle = '#1db954';
  ctx.beginPath();
  ctx.arc(startX + dotR, 115, dotR, 0, Math.PI * 2);
  ctx.fill();

  // Logo text
  ctx.fillStyle = FG_COLOR;
  ctx.fillText(logoText, startX + dotR * 2 + dotGap, 122);
  ctx.letterSpacing = '0px';

  // Thin rule
  ctx.strokeStyle = '#ddd';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(100, 150);
  ctx.lineTo(CW - 100, 150);
  ctx.stroke();
}

function drawReflection(ctx, reflection, y, maxWidth) {
  if (!reflection) return y;
  y += 30;
  ctx.strokeStyle = '#ddd';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo((CW - maxWidth) / 2, y);
  ctx.lineTo((CW + maxWidth) / 2, y);
  ctx.stroke();
  y += 55;

  ctx.font = `italic 30px ${mono}`;
  ctx.fillStyle = FG_COLOR;
  ctx.textAlign = 'center';
  const quoteText = '“' + reflection + '”';
  const lines = getWrappedLines(ctx, quoteText, maxWidth);
  lines.forEach((line, i) => {
    ctx.fillText(line, CW / 2, y + i * 46);
  });
  return y + lines.length * 46 + 20;
}

function drawSubLabel(ctx, text, y) {
  ctx.font = `400 28px ${mono}`;
  ctx.fillStyle = '#555555';
  ctx.textAlign = 'center';
  ctx.letterSpacing = '6px';

  // Measure text to place flanking rules
  const textW = ctx.measureText(text).width + 20; // extra for letter-spacing
  const ruleGap = 24;
  const ruleY = y - 5;
  const ruleLen = 60;

  // Left rule
  ctx.strokeStyle = '#ccc';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(CW / 2 - textW / 2 - ruleGap - ruleLen, ruleY);
  ctx.lineTo(CW / 2 - textW / 2 - ruleGap, ruleY);
  ctx.stroke();

  // Right rule
  ctx.beginPath();
  ctx.moveTo(CW / 2 + textW / 2 + ruleGap, ruleY);
  ctx.lineTo(CW / 2 + textW / 2 + ruleGap + ruleLen, ruleY);
  ctx.stroke();

  ctx.fillText(text, CW / 2, y);
  ctx.letterSpacing = '0px';
}

function drawFooterWm(ctx) {
  const wmY = CH - 80;
  const dotText = 'woodshed';
  ctx.font = `300 18px ${mono}`;
  ctx.letterSpacing = '4px';
  ctx.textAlign = 'left';
  const wmW = ctx.measureText(dotText).width;
  const dotR = 3.5;
  const dotGap = 8;
  const totalW = dotR * 2 + dotGap + wmW;
  const startX = (CW - totalW) / 2;

  // Green dot
  ctx.fillStyle = 'rgba(29,185,84,0.35)';
  ctx.beginPath();
  ctx.arc(startX + dotR, wmY - 5, dotR, 0, Math.PI * 2);
  ctx.fill();

  // Text
  ctx.fillStyle = '#c0bdb6';
  ctx.fillText(dotText, startX + dotR * 2 + dotGap, wmY);
  ctx.letterSpacing = '0px';
}

// ═══════════════════════════════════════════
// ═══════════════════════════════════════════
// CARD 1: WEEK — "I showed up"
// ═══════════════════════════════════════════
function renderWeekCard(ctx, reflection) {
  clearCanvas(ctx);
  drawHeader(ctx);

  const pad = 100;
  const contentW = CW - pad * 2;

  // ── Subtitle ──
  let y = 290;
  drawSubLabel(ctx, 'WEEK IN PRACTICE', y);
  y += 190;

  // ── Big number ──
  const weekHrs = (appData.week.totalMinutes / 60).toFixed(1);
  ctx.font = `200 180px ${mono}`;
  ctx.fillStyle = FG_COLOR;
  ctx.textAlign = 'center';
  ctx.fillText(weekHrs, CW / 2, y);
  y += 50;

  ctx.font = `300 22px ${mono}`;
  ctx.fillStyle = DIM_COLOR;
  ctx.letterSpacing = '5px';
  ctx.fillText('HOURS', CW / 2, y);
  ctx.letterSpacing = '0px';
  y += 100;

  // ── Day grid ──
  const cellGap = 12;
  const cellSize = Math.floor((contentW - 6 * cellGap) / 7);
  const gridWidth = 7 * cellSize + 6 * cellGap;
  const gridX = (CW - gridWidth) / 2;

  const dayLabels = ['M', 'T', 'W', 'T', 'F', 'S', 'S'];
  ctx.font = `400 22px ${mono}`;
  ctx.fillStyle = DIM_COLOR;
  ctx.textAlign = 'center';
  dayLabels.forEach((label, i) => {
    const cx = gridX + i * (cellSize + cellGap) + cellSize / 2;
    ctx.fillText(label, cx, y);
  });
  y += 18;

  let activeDays = 0;
  let weekGigs = 0;
  if (appData.week && appData.week.days) {
    appData.week.days.forEach((day, i) => {
      const cx = gridX + i * (cellSize + cellGap);
      const cy = y;

      if (day.isFuture) {
        ctx.fillStyle = '#e8e5de';
      } else if (day.hasGig) {
        ctx.fillStyle = GIG_COLOR;
        weekGigs++;
      } else {
        ctx.fillStyle = INTENSITY_COLORS[day.intensity] || INTENSITY_COLORS[0];
      }
      if (day.minutes > 0) activeDays++;

      if (day.hasGig && !day.isFuture) {
        ctx.beginPath();
        ctx.arc(cx + cellSize / 2, cy + cellSize / 2, cellSize / 2, 0, Math.PI * 2);
        ctx.fill();
      } else {
        roundRect(ctx, cx, cy, cellSize, cellSize, 10);
        ctx.fill();
      }

      if (!day.isFuture && day.minutes > 0) {
        const isLight = day.intensity <= 1 && !day.hasGig;
        ctx.font = `500 28px ${mono}`;
        ctx.fillStyle = isLight ? 'rgba(0,0,0,0.45)' : 'rgba(255,255,255,0.9)';
        ctx.textAlign = 'center';
        ctx.fillText(day.minutes.toString(), cx + cellSize / 2, cy + cellSize / 2 + 10);
      }
    });
  }
  y += cellSize + 45;

  // Stats line
  ctx.font = `400 22px ${mono}`;
  ctx.fillStyle = DIM_COLOR;
  ctx.textAlign = 'left';
  const gigStr = weekGigs > 0 ? ` · ${weekGigs} gig${weekGigs !== 1 ? 's' : ''}` : '';
  ctx.fillText(`${activeDays} of 7 days${gigStr}`, gridX, y);
  ctx.textAlign = 'right';
  ctx.fillText(`${appData.streak} day streak`, gridX + gridWidth, y);
  y += 110;

  // ── Donut chart ──
  const breakdown = appData.categoryBreakdownWeek || {};
  const cats = Object.entries(breakdown).sort((a, b) => b[1] - a[1]);
  const totalMins = cats.reduce((sum, c) => sum + c[1], 0);

  if (cats.length > 0 && totalMins > 0) {
    const donutCenterX = CW / 2;
    const donutCenterY = y + 210;
    const outerR = 200;
    const innerR = 130;

    // Donut colors — muted palette
    const donutColors = ['#1db954', '#2d2d2d', '#5a5a5a', '#888888', '#aaaaaa', '#cccccc'];

    // Draw segments
    let startAngle = -Math.PI / 2; // start from top
    cats.forEach((cat, i) => {
      const fraction = cat[1] / totalMins;
      const endAngle = startAngle + fraction * Math.PI * 2;

      ctx.beginPath();
      ctx.arc(donutCenterX, donutCenterY, outerR, startAngle, endAngle);
      ctx.arc(donutCenterX, donutCenterY, innerR, endAngle, startAngle, true);
      ctx.closePath();
      ctx.fillStyle = donutColors[i % donutColors.length];
      ctx.fill();

      startAngle = endAngle;
    });

    // Center text — total minutes
    ctx.font = `300 52px ${mono}`;
    ctx.fillStyle = FG_COLOR;
    ctx.textAlign = 'center';
    const totalStr = totalMins >= 60
      ? Math.floor(totalMins / 60) + 'h ' + (totalMins % 60 > 0 ? (totalMins % 60) + 'm' : '')
      : totalMins + 'm';
    ctx.fillText(totalStr.trim(), donutCenterX, donutCenterY + 10);
    ctx.font = `300 18px ${mono}`;
    ctx.fillStyle = DIM_COLOR;
    ctx.letterSpacing = '3px';
    ctx.fillText('TOTAL', donutCenterX, donutCenterY + 42);
    ctx.letterSpacing = '0px';

    y = donutCenterY + outerR + 80;

    // Legend — two columns with proper center gap
    const legendGap = 80;
    const legendColW = (contentW - legendGap) / 2;
    const legendX1 = pad;
    const legendX2 = pad + legendColW + legendGap;
    const legendRowH = 55;

    cats.forEach((cat, i) => {
      const col = i % 2;
      const row = Math.floor(i / 2);
      const lx = col === 0 ? legendX1 : legendX2;
      const ly = y + row * legendRowH;

      // Color dot
      ctx.fillStyle = donutColors[i % donutColors.length];
      ctx.beginPath();
      ctx.arc(lx, ly, 8, 0, Math.PI * 2);
      ctx.fill();

      // Category name
      ctx.font = `500 24px ${mono}`;
      ctx.fillStyle = FG_COLOR;
      ctx.textAlign = 'left';
      ctx.fillText(cat[0], lx + 24, ly + 8);

      // Minutes — right-aligned within column
      const mins = cat[1];
      const hrsStr = mins >= 60
        ? parseFloat((mins / 60).toFixed(1)) + 'h'
        : mins + 'm';
      ctx.font = `400 22px ${mono}`;
      ctx.fillStyle = DIM_COLOR;
      ctx.textAlign = 'right';
      ctx.fillText(hrsStr, lx + legendColW, ly + 8);
    });

    y += Math.ceil(cats.length / 2) * legendRowH + 40;
  }

  // Reflection — but cap it so it doesn't collide with footer
  const footerZone = CH - 120; // watermark at CH-80, leave 40px buffer
  if (reflection && y < footerZone - 100) {
    y = drawReflection(ctx, reflection, y, gridWidth);
  }
  drawFooterWm(ctx);
}

// ═══════════════════════════════════════════
// CARD 2: MONTH — "What I worked on"
// ═══════════════════════════════════════════
function renderMonthCard(ctx, reflection) {
  clearCanvas(ctx);
  drawHeader(ctx);

  const pad = 100;
  const contentW = CW - pad * 2;

  // ── Subtitle ──
  let y = 270;
  const monthName = (appData.month.name || 'THIS MONTH').toUpperCase();
  drawSubLabel(ctx, monthName + ' ' + new Date().getFullYear(), y);
  y += 170;

  // ── Big number ──
  const monthHrs = parseFloat((appData.month.totalMinutes / 60).toFixed(1));
  ctx.font = `200 150px ${mono}`;
  ctx.fillStyle = FG_COLOR;
  ctx.textAlign = 'center';
  ctx.fillText(monthHrs.toString(), CW / 2, y);
  y += 42;

  ctx.font = `300 22px ${mono}`;
  ctx.fillStyle = DIM_COLOR;
  ctx.letterSpacing = '5px';
  ctx.fillText('HOURS', CW / 2, y);
  ctx.letterSpacing = '0px';
  y += 70;

  // ── Calendar grid ──
  const now = new Date();
  const yr = now.getFullYear();
  const mo = now.getMonth();
  const daysInMonth = new Date(yr, mo + 1, 0).getDate();
  let startDow = new Date(yr, mo, 1).getDay() - 1;
  if (startDow < 0) startDow = 6;

  const totalSlots = startDow + daysInMonth;
  const calRows = Math.ceil(totalSlots / 7);

  const jan1 = new Date(yr, 0, 1);
  let jan1Dow = jan1.getDay() - 1;
  if (jan1Dow < 0) jan1Dow = 6;
  const gridStart = new Date(jan1);
  gridStart.setDate(gridStart.getDate() - jan1Dow);

  function gridIndexForDay(d) {
    const date = new Date(yr, mo, d);
    const diff = Math.floor((date - gridStart) / 86400000);
    if (diff < 0 || diff >= 364) return -1;
    return diff;
  }

  const cellGap = 7;
  const cellSize = 72;
  const calW = 7 * cellSize + 6 * cellGap;
  const calX = (CW - calW) / 2;

  const dayLabels = ['M', 'T', 'W', 'T', 'F', 'S', 'S'];
  ctx.font = `400 18px ${mono}`;
  ctx.fillStyle = DIM_COLOR;
  ctx.textAlign = 'center';
  dayLabels.forEach((label, i) => {
    ctx.fillText(label, calX + i * (cellSize + cellGap) + cellSize / 2, y);
  });
  y += 14;

  let dayNum = 1;
  let activeDays = 0;
  let calGigs = 0;

  for (let row = 0; row < calRows; row++) {
    for (let col = 0; col < 7; col++) {
      const slot = row * 7 + col;
      if (slot < startDow || dayNum > daysInMonth) continue;

      const cx = calX + col * (cellSize + cellGap);
      const cy = y + row * (cellSize + cellGap);
      const isFuture = new Date(yr, mo, dayNum) > now;

      let intensity = 0;
      let hasGig = false;
      const gi = gridIndexForDay(dayNum);
      if (gi >= 0 && gi < appData.grid.length) {
        intensity = appData.grid[gi].intensity;
        hasGig = appData.grid[gi].hasGig;
      }

      if (intensity > 0 || hasGig) activeDays++;
      if (hasGig) calGigs++;

      if (isFuture) {
        ctx.fillStyle = '#e8e5de';
      } else if (hasGig) {
        ctx.fillStyle = GIG_COLOR;
      } else {
        ctx.fillStyle = INTENSITY_COLORS[Math.max(0, intensity)] || INTENSITY_COLORS[0];
      }

      if (hasGig && !isFuture) {
        ctx.beginPath();
        ctx.arc(cx + cellSize / 2, cy + cellSize / 2, cellSize / 2, 0, Math.PI * 2);
        ctx.fill();
      } else {
        roundRect(ctx, cx, cy, cellSize, cellSize, 6);
        ctx.fill();
      }

      const isLight = intensity <= 1 && !hasGig;
      ctx.font = `500 18px ${mono}`;
      ctx.fillStyle = isFuture
        ? 'rgba(0,0,0,0.15)'
        : isLight ? 'rgba(0,0,0,0.3)' : 'rgba(255,255,255,0.85)';
      ctx.textAlign = 'center';
      ctx.fillText(dayNum.toString(), cx + cellSize / 2, cy + cellSize / 2 + 6);

      dayNum++;
    }
  }

  y += calRows * (cellSize + cellGap) + 28;

  // Stats line — gigs folded in as orange text
  ctx.font = `400 22px ${mono}`;
  ctx.fillStyle = DIM_COLOR;
  ctx.textAlign = 'left';
  ctx.fillText(`${activeDays} days practiced`, calX, y);
  if (calGigs > 0) {
    const dpW = ctx.measureText(`${activeDays} days practiced `).width;
    ctx.fillStyle = GIG_COLOR;
    ctx.fillText(`◆ ${calGigs}`, calX + dpW + 8, y);
  }
  ctx.fillStyle = DIM_COLOR;
  ctx.textAlign = 'right';
  ctx.fillText(`${appData.streak} day streak`, calX + calW, y);
  y += 70;

  // ── Donut chart + legend side by side ──
  const breakdown = appData.categoryBreakdownMonth || {};
  const cats = Object.entries(breakdown).sort((a, b) => b[1] - a[1]);
  const totalMins = cats.reduce((sum, c) => sum + c[1], 0);

  if (cats.length > 0 && totalMins > 0) {
    const outerR = 125;
    const innerR = 80;
    const donutCenterX = pad + outerR + 30;
    const donutCenterY = y + outerR + 10;

    const donutColors = ['#1db954', '#2d2d2d', '#5a5a5a', '#888888', '#aaaaaa', '#cccccc'];

    let startAngle = -Math.PI / 2;
    cats.forEach((cat, i) => {
      const fraction = cat[1] / totalMins;
      const endAngle = startAngle + fraction * Math.PI * 2;
      ctx.beginPath();
      ctx.arc(donutCenterX, donutCenterY, outerR, startAngle, endAngle);
      ctx.arc(donutCenterX, donutCenterY, innerR, endAngle, startAngle, true);
      ctx.closePath();
      ctx.fillStyle = donutColors[i % donutColors.length];
      ctx.fill();
      startAngle = endAngle;
    });

    // Center text
    ctx.font = `300 36px ${mono}`;
    ctx.fillStyle = FG_COLOR;
    ctx.textAlign = 'center';
    const totalStr = totalMins >= 60
      ? Math.floor(totalMins / 60) + 'h ' + (totalMins % 60 > 0 ? (totalMins % 60) + 'm' : '')
      : totalMins + 'm';
    ctx.fillText(totalStr.trim(), donutCenterX, donutCenterY + 8);
    ctx.font = `300 13px ${mono}`;
    ctx.fillStyle = DIM_COLOR;
    ctx.letterSpacing = '3px';
    ctx.fillText('PRACTICE', donutCenterX, donutCenterY + 30);
    ctx.letterSpacing = '0px';

    // Legend — single column to the right of donut
    const legendX = donutCenterX + outerR + 60;
    const legendRowH = 42;
    const legendTopY = donutCenterY - ((cats.length * legendRowH) / 2) + 10;

    cats.forEach((cat, i) => {
      const ly = legendTopY + i * legendRowH;

      ctx.fillStyle = donutColors[i % donutColors.length];
      ctx.beginPath();
      ctx.arc(legendX, ly, 6, 0, Math.PI * 2);
      ctx.fill();

      ctx.font = `500 20px ${mono}`;
      ctx.fillStyle = FG_COLOR;
      ctx.textAlign = 'left';
      ctx.fillText(cat[0], legendX + 20, ly + 6);

      const mins = cat[1];
      const hrsStr = mins >= 60
        ? parseFloat((mins / 60).toFixed(1)) + 'h'
        : mins + 'm';
      ctx.font = `400 18px ${mono}`;
      ctx.fillStyle = DIM_COLOR;
      ctx.textAlign = 'right';
      ctx.fillText(hrsStr, CW - pad, ly + 6);
    });

    y = donutCenterY + outerR + 40;
  }

  // Reflection
  const footerZone = CH - 120;
  if (reflection && y < footerZone - 100) {
    y = drawReflection(ctx, reflection, y, contentW);
  }
  drawFooterWm(ctx);
}

// ═══════════════════════════════════════════
// CARD 3: YEAR — "The long game"
// ═══════════════════════════════════════════
function renderYearCard(ctx, reflection) {
  clearCanvas(ctx);
  drawHeader(ctx);

  const pad = 100;
  const contentW = CW - pad * 2;

  // ── Subtitle ──
  let y = 270;
  drawSubLabel(ctx, 'THE LONG GAME', y);
  y += 180;

  // ── Year hours ──
  const yearHrs = Math.round((appData.year ? appData.year.totalMinutes : 0) / 60);
  ctx.font = `200 180px ${mono}`;
  ctx.fillStyle = FG_COLOR;
  ctx.textAlign = 'center';
  ctx.fillText(yearHrs.toString(), CW / 2, y);
  y += 45;

  ctx.font = `300 22px ${mono}`;
  ctx.fillStyle = DIM_COLOR;
  ctx.letterSpacing = '5px';
  ctx.fillText('HOURS IN ' + new Date().getFullYear(), CW / 2, y);
  ctx.letterSpacing = '0px';
  y += 80;

  // ── Three stat boxes ──
  const monthHrs = parseFloat((appData.month.totalMinutes / 60).toFixed(1));
  const weekHrs = parseFloat((appData.week.totalMinutes / 60).toFixed(1));
  const colGap = 16;
  const colW = Math.floor((contentW - 2 * colGap) / 3);
  const colH = 110;
  const colX = pad;

  const statItems = [
    { num: weekHrs.toString(), label: 'THIS WEEK' },
    { num: appData.streak.toString(), label: 'DAY STREAK' },
    { num: monthHrs.toString(), label: 'IN ' + (appData.month.name || '--').toUpperCase() },
  ];

  statItems.forEach((s, i) => {
    const sx = colX + i * (colW + colGap);

    ctx.strokeStyle = '#ddd';
    ctx.lineWidth = 1;
    roundRect(ctx, sx, y, colW, colH, 8);
    ctx.stroke();

    ctx.font = `300 42px ${mono}`;
    ctx.fillStyle = FG_COLOR;
    ctx.textAlign = 'center';
    ctx.fillText(s.num, sx + colW / 2, y + 48);

    ctx.font = `300 15px ${mono}`;
    ctx.fillStyle = DIM_COLOR;
    ctx.letterSpacing = '2px';
    ctx.fillText(s.label, sx + colW / 2, y + 78);
    ctx.letterSpacing = '0px';
  });
  y += colH + 60;

  // ── Contribution grid — current half of year ──
  if (appData.grid && appData.grid.length > 0) {
    const now = new Date();
    const isSecondHalf = now.getMonth() >= 6;
    const halfStartMonth = isSecondHalf ? 6 : 0;
    const halfEndMonth = isSecondHalf ? 11 : 5;
    const halfLabels = isSecondHalf
      ? ['J', 'A', 'S', 'O', 'N', 'D']
      : ['J', 'F', 'M', 'A', 'M', 'J'];

    // Calculate grid index range for this half
    const yr = now.getFullYear();
    const jan1 = new Date(yr, 0, 1);
    let jan1Dow = jan1.getDay() - 1;
    if (jan1Dow < 0) jan1Dow = 6;
    const gridStart = new Date(jan1);
    gridStart.setDate(gridStart.getDate() - jan1Dow);

    const halfStartDate = new Date(yr, halfStartMonth, 1);
    const halfEndDate = new Date(yr, halfEndMonth + 1, 0); // last day of end month
    const startIdx = Math.max(0, Math.floor((halfStartDate - gridStart) / 86400000));
    const endIdx = Math.min(appData.grid.length - 1, Math.floor((halfEndDate - gridStart) / 86400000));

    // Only include weeks whose Thursday falls within the half
    let startWeek = Math.floor(startIdx / 7);
    let endWeek = Math.floor(endIdx / 7);
    // Trim start: if Thursday of startWeek is before halfStartDate, skip it
    while (startWeek <= endWeek) {
      const thu = new Date(gridStart.getTime() + (startWeek * 7 + 3) * 86400000);
      if (thu.getMonth() >= halfStartMonth) break;
      startWeek++;
    }
    // Trim end: if Thursday of endWeek is after halfEndMonth, skip it
    while (endWeek >= startWeek) {
      const thu = new Date(gridStart.getTime() + (endWeek * 7 + 3) * 86400000);
      if (thu.getMonth() <= halfEndMonth) break;
      endWeek--;
    }

    // Slice to weeks — track which month each week starts in
    const cols = endWeek - startWeek + 1;
    const rows = 7;
    const cellGap = 4;
    const monthGap = 10; // extra gap between months

    // Figure out which columns have a month boundary before them
    // Use Thursday of each week to determine month ownership (ISO standard)
    const monthBreaks = new Set();
    function weekThursday(week) {
      return new Date(gridStart.getTime() + (week * 7 + 3) * 86400000);
    }
    for (let week = startWeek + 1; week <= endWeek; week++) {
      const prevThu = weekThursday(week - 1);
      const currThu = weekThursday(week);
      if (prevThu.getMonth() !== currThu.getMonth()) {
        monthBreaks.add(week - startWeek);
      }
    }

    // Calculate total width with month gaps
    const numBreaks = monthBreaks.size;
    const availW = contentW - numBreaks * monthGap;
    const cellSize = Math.floor((availW - (cols - 1) * cellGap) / cols);
    
    // Build x-positions for each column
    const colX = [];
    let cx = 0;
    for (let c = 0; c < cols; c++) {
      if (monthBreaks.has(c)) cx += monthGap;
      colX.push(cx);
      cx += cellSize + cellGap;
    }
    const gridW = colX[cols - 1] + cellSize;
    const gridXStart = (CW - gridW) / 2;

    // Month labels — derive from Thursday of each column's week
    ctx.font = `500 22px ${mono}`;
    ctx.fillStyle = '#555555';
    ctx.textAlign = 'center';
    const monthNames = ['J','F','M','A','M','J','J','A','S','O','N','D'];
    let prevLabelMonth = -1;
    let monthColStart = 0;
    
    for (let c = 0; c <= cols; c++) {
      const isEnd = c === cols;
      let currMonth = -1;
      if (!isEnd) {
        const thu = weekThursday(startWeek + c);
        currMonth = thu.getMonth();
      }
      
      if (isEnd || (c > 0 && monthBreaks.has(c))) {
        // Draw label for the previous month group
        const midX = (colX[monthColStart] + colX[c - 1] + cellSize) / 2;
        ctx.fillText(monthNames[prevLabelMonth], gridXStart + midX, y);
        monthColStart = c;
      }
      if (!isEnd) prevLabelMonth = currMonth;
    }
    y += 22;

    // Grid cells
    for (let week = startWeek; week <= endWeek; week++) {
      for (let row = 0; row < rows; row++) {
        const i = week * 7 + row;
        if (i < 0 || i >= appData.grid.length) continue;
        const cell = appData.grid[i];
        const col = week - startWeek;
        const cx = gridXStart + colX[col];
        const cy = y + row * (cellSize + cellGap);

        if (cell.hasGig) {
          ctx.fillStyle = GIG_COLOR;
        } else if (cell.intensity === -1) {
          ctx.fillStyle = '#eae7e0';
        } else {
          ctx.fillStyle = INTENSITY_COLORS[cell.intensity] || INTENSITY_COLORS[0];
        }
        roundRect(ctx, cx, cy, cellSize, cellSize, 2);
        ctx.fill();
      }
    }

    y += rows * (cellSize + cellGap) + 24;

    // Legend — centered
    const swatchSize = 12;
    const swatchGap = 4;
    const legendColors = [INTENSITY_COLORS[0], INTENSITY_COLORS[1], INTENSITY_COLORS[2], INTENSITY_COLORS[3], INTENSITY_COLORS[4]];
    ctx.font = `400 16px ${mono}`;
    const lessW = ctx.measureText('less ').width;
    const moreW = ctx.measureText(' more').width;
    const dotW = ctx.measureText(' · ').width;
    const gigW = ctx.measureText(' gig').width;
    const swatchesW = legendColors.length * (swatchSize + swatchGap);
    const gigSwatchW = swatchSize;
    const totalLegendW = lessW + swatchesW + moreW + dotW + gigSwatchW + gigW;
    let lx = (CW - totalLegendW) / 2;

    ctx.fillStyle = DIM_COLOR;
    ctx.textAlign = 'left';
    ctx.fillText('less', lx, y);
    lx += lessW;

    legendColors.forEach((c, ci) => {
      ctx.fillStyle = c;
      roundRect(ctx, lx + ci * (swatchSize + swatchGap), y - swatchSize + 3, swatchSize, swatchSize, 2);
      ctx.fill();
    });
    lx += swatchesW;

    ctx.fillStyle = DIM_COLOR;
    ctx.fillText(' more', lx, y);
    lx += moreW;

    ctx.fillText(' · ', lx, y);
    lx += dotW;

    ctx.fillStyle = GIG_COLOR;
    roundRect(ctx, lx, y - swatchSize + 3, swatchSize, swatchSize, 2);
    ctx.fill();
    lx += gigSwatchW;

    ctx.fillStyle = DIM_COLOR;
    ctx.fillText(' gig', lx, y);

    y += 60;
  }

  // ── Donut chart + legend side by side (yearly breakdown) ──
  const breakdown = appData.categoryBreakdown || {};
  const cats = Object.entries(breakdown).sort((a, b) => b[1] - a[1]);
  const totalMins = cats.reduce((sum, c) => sum + c[1], 0);

  if (cats.length > 0 && totalMins > 0) {
    const outerR = 120;
    const innerR = 78;
    const donutCenterX = pad + outerR + 30;
    const donutCenterY = y + outerR + 10;

    const donutColors = ['#1db954', '#2d2d2d', '#5a5a5a', '#888888', '#aaaaaa', '#cccccc'];

    let startAngle = -Math.PI / 2;
    cats.forEach((cat, i) => {
      const fraction = cat[1] / totalMins;
      const endAngle = startAngle + fraction * Math.PI * 2;
      ctx.beginPath();
      ctx.arc(donutCenterX, donutCenterY, outerR, startAngle, endAngle);
      ctx.arc(donutCenterX, donutCenterY, innerR, endAngle, startAngle, true);
      ctx.closePath();
      ctx.fillStyle = donutColors[i % donutColors.length];
      ctx.fill();
      startAngle = endAngle;
    });

    // Center text
    ctx.font = `300 34px ${mono}`;
    ctx.fillStyle = FG_COLOR;
    ctx.textAlign = 'center';
    const totalStr = totalMins >= 60
      ? Math.floor(totalMins / 60) + 'h ' + (totalMins % 60 > 0 ? (totalMins % 60) + 'm' : '')
      : totalMins + 'm';
    ctx.fillText(totalStr.trim(), donutCenterX, donutCenterY + 8);
    ctx.font = `300 12px ${mono}`;
    ctx.fillStyle = DIM_COLOR;
    ctx.letterSpacing = '3px';
    ctx.fillText('ALL TIME', donutCenterX, donutCenterY + 28);
    ctx.letterSpacing = '0px';

    // Legend — single column to the right
    const legendX = donutCenterX + outerR + 60;
    const legendRowH = 42;
    const legendTopY = donutCenterY - ((cats.length * legendRowH) / 2) + 10;

    cats.forEach((cat, i) => {
      const ly = legendTopY + i * legendRowH;

      ctx.fillStyle = donutColors[i % donutColors.length];
      ctx.beginPath();
      ctx.arc(legendX, ly, 6, 0, Math.PI * 2);
      ctx.fill();

      ctx.font = `500 20px ${mono}`;
      ctx.fillStyle = FG_COLOR;
      ctx.textAlign = 'left';
      ctx.fillText(cat[0], legendX + 20, ly + 6);

      const mins = cat[1];
      const hrsStr = mins >= 60
        ? parseFloat((mins / 60).toFixed(1)) + 'h'
        : mins + 'm';
      ctx.font = `400 18px ${mono}`;
      ctx.fillStyle = DIM_COLOR;
      ctx.textAlign = 'right';
      ctx.fillText(hrsStr, CW - pad, ly + 6);
    });

    y = donutCenterY + outerR + 40;
  }

  // Reflection
  const footerZone = CH - 120;
  if (reflection && y < footerZone - 100) {
    y = drawReflection(ctx, reflection, y, contentW);
  }
  drawFooterWm(ctx);
}

// Save / Share
document.getElementById('save-image-btn').addEventListener('click', () => {
  const canvas = document.getElementById('share-canvas');
  const link = document.createElement('a');
  link.download = `woodshed-${selectedCardType}.png`;
  link.href = canvas.toDataURL('image/png');
  link.click();
  showToast('image saved');
});

document.getElementById('share-btn').addEventListener('click', async () => {
  const canvas = document.getElementById('share-canvas');
  try {
    const blob = await new Promise(r => canvas.toBlob(r, 'image/png'));
    const file = new File([blob], `woodshed-${selectedCardType}.png`, { type: 'image/png' });
    if (navigator.share && navigator.canShare({ files: [file] })) {
      await navigator.share({ files: [file] });
    } else {
      const link = document.createElement('a');
      link.download = `woodshed-${selectedCardType}.png`;
      link.href = URL.createObjectURL(blob);
      link.click();
      showToast('image saved (share not supported)');
    }
  } catch (err) {
    console.log('Share cancelled or failed');
  }
});


// ═══════════════════════════════════════════
// CANVAS DRAWING UTILS
// ═══════════════════════════════════════════
function roundRect(ctx, x, y, w, h, r) {
  ctx.beginPath();
  ctx.moveTo(x + r, y);
  ctx.lineTo(x + w - r, y);
  ctx.quadraticCurveTo(x + w, y, x + w, y + r);
  ctx.lineTo(x + w, y + h - r);
  ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
  ctx.lineTo(x + r, y + h);
  ctx.quadraticCurveTo(x, y + h, x, y + h - r);
  ctx.lineTo(x, y + r);
  ctx.quadraticCurveTo(x, y, x + r, y);
  ctx.closePath();
}

function getWrappedLines(ctx, text, maxWidth) {
  const words = text.split(' ');
  const lines = [];
  let line = '';
  for (const word of words) {
    const test = line + (line ? ' ' : '') + word;
    if (ctx.measureText(test).width > maxWidth && line) {
      lines.push(line);
      line = word;
    } else {
      line = test;
    }
  }
  if (line) lines.push(line);
  return lines;
}

function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
  const lines = getWrappedLines(ctx, text, maxWidth);
  lines.forEach((line, i) => {
    ctx.fillText(line, x, y + i * lineHeight);
  });
}

// ═══════════════════════════════════════════
// HELPERS
// ═══════════════════════════════════════════
function formatHours(minutes) {
  if (minutes < 60) return `${minutes}m`;
  const h = Math.floor(minutes / 60);
  const m = minutes % 60;
  return m > 0 ? `${h}h ${m}m` : `${h}h`;
}

function formatMinutes(minutes) {
  if (minutes < 60) return `${minutes}m`;
  const h = Math.floor(minutes / 60);
  const m = minutes % 60;
  return m > 0 ? `${h}h ${m}m` : `${h}h`;
}

function timeAgo(date) {
  const now = new Date();
  const diffMs = now - date;
  const diffMins = Math.floor(diffMs / 60000);
  const diffHrs = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);

  if (diffMins < 1) return 'just now';
  if (diffMins < 60) return `${diffMins}m ago`;
  if (diffHrs < 24) return `${diffHrs}h ago`;
  if (diffDays === 1) return '1d ago';
  return `${diffDays}d ago`;
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2000);
}

// ═══════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════
fetchStats();

// Register service worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').catch(() => {});
}
</script>
</body>
</html>

